<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent | Register / Login</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Netlify Identity Widget -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { gold: '#c9a14a', 'gold-soft': '#f5e6b3', blackish: '#050505', darkish: '#0b0b0b' },
          fontFamily: { inter: ['Inter', 'sans-serif'], playfair: ['Playfair Display', 'serif'] },
          boxShadow: { goldGlow: '0 0 34px rgba(201,161,74,.22)' }
        }
      }
    }
  </script>

  <style>
    body {
      background: radial-gradient(circle at top, #121212, #000 70%);
    }
  </style>
</head>

<body class="m-0 font-inter text-white/90 min-h-screen flex flex-col">

  <header class="sticky top-0 z-50 backdrop-blur bg-black/55 border-b border-gold/15">
    <div class="px-[6%] md:px-[8%] py-3 flex items-center justify-between gap-3">
      <a href="index.html" class="no-underline flex items-center gap-2 min-w-0">
        <span class="font-playfair text-gold-soft text-lg md:text-xl whitespace-nowrap">QariLive™</span>
        <span class="hidden sm:inline-block text-xs text-white/45 truncate">Agent Portal</span>
      </a>

      <a href="index.html"
        class="shrink-0 px-4 py-2 rounded-full font-semibold text-black no-underline bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
        Back to Site
      </a>
    </div>
  </header>

  <main class="flex-1 px-[6%] md:px-[8%] py-10 md:py-12">
    <div class="max-w-[980px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

      <section class="lg:col-span-5 rounded-2xl border border-gold/15 bg-black/30 p-6">
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-gold/25 bg-black/30 shadow-[0_0_18px_rgba(201,161,74,.10)]">
          <span class="w-2 h-2 rounded-full bg-gold"></span>
          <span class="text-gold-soft text-xs">Agent Account</span>
        </div>

        <h1 class="mt-4 font-playfair text-gold-soft text-[2.0rem] leading-tight">
          Register / Login
        </h1>

        <p class="mt-2 text-white/70">
          You are registering under Master Agent REF:
          <span id="maRefLabel" class="text-gold-soft font-semibold">—</span>
        </p>

        <div class="mt-6 rounded-2xl border border-gold/15 bg-black/20 p-4 text-sm text-white/70">
          <div class="font-semibold text-gold-soft">Your job</div>
          <ul class="mt-2 space-y-2">
            <li>• Collect customer details</li>
            <li>• Upload proof of purchase</li>
            <li>• Admin verifies and approves</li>
          </ul>
        </div>
      </section>

      <section
        class="lg:col-span-7 rounded-2xl border border-gold/15 bg-[linear-gradient(180deg,#101010,#060606)] shadow-[0_0_25px_rgba(0,0,0,.6)] p-6">
        <div class="flex items-center justify-between gap-3">
          <h2 class="font-playfair text-gold-soft text-[1.6rem]">Agent Access</h2>
          <div class="text-xs text-white/45">Netlify Identity</div>
        </div>

        <div class="mt-5 flex flex-wrap gap-2">
          <button id="tabRegister" type="button"
            class="px-4 py-2 rounded-full border border-gold/35 text-gold-soft bg-black/30 hover:border-gold/60 hover:bg-black/40 transition">
            Register
          </button>
          <button id="tabLogin" type="button"
            class="px-4 py-2 rounded-full border border-white/10 text-white/80 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition">
            Login
          </button>
        </div>

        <div id="alertBox" class="hidden mt-4 rounded-2xl border border-gold/20 bg-black/30 p-4 text-sm text-white/80">
        </div>

        <form id="registerForm" class="mt-5 space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-white/55">Full Name</label>
              <input id="regName" required
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:outline-none focus:border-gold/60"
                placeholder="e.g. Ahmad bin Ali" />
            </div>
            <div>
              <label class="text-xs text-white/55">WhatsApp Number</label>
              <input id="regWhatsapp" required inputmode="numeric"
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:outline-none focus:border-gold/60"
                placeholder="e.g. 60123456789" />
              <div class="mt-1 text-[11px] text-white/40">Use country code (no +, no spaces).</div>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-white/55">Email</label>
              <input id="regEmail" type="email" required
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:outline-none focus:border-gold/60"
                placeholder="you@email.com" />
            </div>
            <div>
              <label class="text-xs text-white/55">Password</label>
              <input id="regPassword" type="password" required minlength="8"
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:outline-none focus:border-gold/60"
                placeholder="Min 8 characters" />
            </div>
          </div>

          <button type="submit"
            class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
            Create Agent Account
          </button>
        </form>

        <form id="loginForm" class="mt-5 space-y-4 hidden">
          <div>
            <label class="text-xs text-white/55">Email</label>
            <input id="loginEmail" type="email" required
              class="mt-1 w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:outline-none focus:border-gold/60"
              placeholder="you@email.com" />
          </div>
          <div>
            <label class="text-xs text-white/55">Password</label>
            <input id="loginPassword" type="password" required
              class="mt-1 w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:outline-none focus:border-gold/60"
              placeholder="Your password" />
          </div>

          <button type="submit"
            class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
            Login
          </button>

          <button type="button" id="openRecovery"
            class="w-full px-4 py-3 rounded-xl font-semibold border border-white/10 text-white/80 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition">
            Forgot Password
          </button>
        </form>
      </section>

    </div>
  </main>

  <footer class="mt-auto border-t border-gold/15 bg-black/60 px-[6%] md:px-[8%] py-10 text-center">
    <small class="text-white/45">© 2025 IT People Sdn Bhd • QariLive Operations</small>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);

    const url = new URL(window.location.href);
    const maRef = (url.searchParams.get("ref") || "").trim().toUpperCase();
    $("maRefLabel").textContent = maRef || "MISSING REF";

    const alertBox = $("alertBox");
    function showAlert(msg, type = "info") {
      alertBox.classList.remove("hidden");
      alertBox.textContent = msg;

      alertBox.classList.remove("border-red-500/25", "bg-red-500/10", "border-gold/20", "bg-black/30");
      if (type === "error") {
        alertBox.classList.add("border-red-500/25", "bg-red-500/10");
      } else {
        alertBox.classList.add("border-gold/20", "bg-black/30");
      }
    }
    function hideAlert() { alertBox.classList.add("hidden"); alertBox.textContent = ""; }

    function safeRedirect(url) { window.location.href = url; }

    const tabRegister = $("tabRegister");
    const tabLogin = $("tabLogin");
    const registerForm = $("registerForm");
    const loginForm = $("loginForm");

    function setTab(which) {
      hideAlert();
      const isReg = which === "register";
      registerForm.classList.toggle("hidden", !isReg);
      loginForm.classList.toggle("hidden", isReg);

      tabRegister.className = isReg
        ? "px-4 py-2 rounded-full border border-gold/35 text-gold-soft bg-black/30 hover:border-gold/60 hover:bg-black/40 transition"
        : "px-4 py-2 rounded-full border border-white/10 text-white/80 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition";

      tabLogin.className = !isReg
        ? "px-4 py-2 rounded-full border border-gold/35 text-gold-soft bg-black/30 hover:border-gold/60 hover:bg-black/40 transition"
        : "px-4 py-2 rounded-full border border-white/10 text-white/80 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition";
    }
    tabRegister.addEventListener("click", () => setTab("register"));
    tabLogin.addEventListener("click", () => setTab("login"));

    function waitForIdentity() {
      return new Promise((resolve) => {
        const tick = () => {
          if (window.netlifyIdentity) return resolve(window.netlifyIdentity);
          setTimeout(tick, 50);
        };
        tick();
      });
    }

    async function handleIdentityHashTokens() {
      const identity = await waitForIdentity();
      identity.init();

      const hash = window.location.hash || "";
      const hasToken =
        hash.includes("confirmation_token=") ||
        hash.includes("recovery_token=") ||
        hash.includes("invite_token=") ||
        hash.includes("access_token=");

      if (!hasToken) return false;

      // Let Netlify Identity consume the token properly
      // then send user back to the correct login page (keep ?ref for agent)
      identity.on("login", (user) => {
        const role = (user?.user_metadata?.role || "").toLowerCase();

        if (role === "master_agent") {
          return safeRedirect("master-agent-dashboard.html");
        }

        // default: agent
        return safeRedirect("agent-dashboard.html");
      });


      // This triggers the widget to process the hash tokens
      identity.open();
      return true;
    }


    async function init() {
      const consumed = await handleIdentityHashTokens();
      if (consumed) return; // stop normal redirects so token isn't lost

      const identity = await waitForIdentity();
      identity.init();

      const u = identity.currentUser();
      if (u) {
        const role = (u.user_metadata?.role || "").toLowerCase();
        if (role === "agent") safeRedirect("agent-dashboard.html");
        else safeRedirect("master-agent-dashboard.html");
      }


      const role = (u.user_metadata?.role || "").toLowerCase();
      if (role === "agent") return safeRedirect("agent-dashboard.html");
      return safeRedirect("master-agent-dashboard.html");
    }


    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideAlert();

      if (!maRef) {
        showAlert("Missing MA REF in URL. Please register using the link from your Master Agent.", "error");
        return;
      }

      try {
        const identity = await waitForIdentity();
        identity.init();

        const name = $("regName").value.trim();
        const whatsapp = $("regWhatsapp").value.trim();
        const email = $("regEmail").value.trim();
        const password = $("regPassword").value;

        await identity.gotrue.signup(
          email,
          password,
          {
            data: {
              role: "agent",
              full_name: name,
              whatsapp,
              parent_ma_code: maRef
            }
          }
        );

        showAlert("✅ Agent account created. Please verify email (if required), then login. Redirecting...");
        setTimeout(() => safeRedirect("agent-auth.html?ref=" + encodeURIComponent(maRef)), 900);
        setTab("login");

      } catch (err) {
        showAlert(err?.message || "Registration failed.", "error");
      }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideAlert();

      try {
        const identity = await waitForIdentity();
        identity.init();

        const email = $("loginEmail").value.trim();
        const password = $("loginPassword").value;

        await identity.gotrue.login(email, password, true);
        safeRedirect("agent-dashboard.html");
      } catch (err) {
        showAlert(err?.message || "Login failed.", "error");
      }
    });

    $("openRecovery").addEventListener("click", async () => {
      hideAlert();
      try {
        const identity = await waitForIdentity();
        identity.open("recovery");
      } catch {
        showAlert("Unable to open recovery. Please try again.", "error");
      }
    });

    init();
  </script>
</body>

</html>