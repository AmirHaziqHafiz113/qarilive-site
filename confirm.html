<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirming… | QariLive</title>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body style="margin:0;padding:0;background:#0b0b0b;color:#eee;font-family:system-ui;">
  <div style="max-width:720px;margin:0 auto;padding:28px 16px;">
    <h2 style="margin:0 0 10px 0;">Confirming your account…</h2>
    <p style="margin:0;color:rgba(255,255,255,.75)">Please wait. Do not close this tab.</p>
  </div>

  <script>
    function waitForIdentity(){
      return new Promise((resolve) => {
        const t = () => window.netlifyIdentity ? resolve(window.netlifyIdentity) : setTimeout(t, 50);
        t();
      });
    }

    (async () => {
      const identity = await waitForIdentity();
      identity.init();

      const hash = window.location.hash || "";
      const hasToken =
        hash.includes("confirmation_token=") ||
        hash.includes("recovery_token=") ||
        hash.includes("invite_token=") ||
        hash.includes("access_token=");

      if (!hasToken) {
        // no token → just go to master login by default
        window.location.replace("/master-agent-auth.html");
        return;
      }

      // When token is processed, Netlify Identity usually logs the user in.
      identity.on("login", async (user) => {
        try {
          const role = (user?.user_metadata?.role || "").toLowerCase();
          // IMPORTANT: logout so user lands on login page (your requirement)
          await identity.logout();

          if (role === "agent") window.location.replace("/agent-auth.html?verified=1");
          else window.location.replace("/master-agent-auth.html?verified=1");
        } catch (e) {
          // fallback
          window.location.replace("/master-agent-auth.html?verified=1");
        }
      });

      // Trigger token consumption
      identity.open();
    })();
  </script>
</body>
</html>
