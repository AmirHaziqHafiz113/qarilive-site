<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Dashboard | QariLive</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Netlify Identity Widget -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { gold: '#c9a14a', 'gold-soft': '#f5e6b3', blackish: '#050505', darkish: '#0b0b0b' },
          fontFamily: { inter: ['Inter', 'sans-serif'], playfair: ['Playfair Display', 'serif'] },
          boxShadow: { goldGlow: '0 0 34px rgba(201,161,74,.22)' }
        }
      }
    }
  </script>

  <style>
    body { background: radial-gradient(circle at top, #121212, #000 70%); }
    .soft-border { border: 1px solid rgba(255, 255, 255, .10); }
    .focus-gold:focus {
      outline: none;
      border-color: rgba(201, 161, 74, .65);
      box-shadow: 0 0 0 4px rgba(201, 161, 74, .12);
    }
    .glass { background: rgba(0,0,0,.30); border: 1px solid rgba(201,161,74,.15); }
    th.sortable { cursor:pointer; user-select:none; }
    th.sortable:hover { background: rgba(0,0,0,.35); }
  </style>
</head>

<body class="m-0 font-inter text-white/90 min-h-screen flex flex-col">

  <header class="sticky top-0 z-50 backdrop-blur bg-black/55 border-b border-gold/15">
    <div class="max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-3">
      <a href="index.html" class="no-underline flex items-center gap-2 min-w-0">
        <span class="font-playfair text-gold-soft text-lg md:text-xl whitespace-nowrap">QariLive™</span>
        <span class="hidden sm:inline-block text-xs text-white/45 truncate">Agent Dashboard</span>
      </a>

      <button id="btnLogout"
        class="shrink-0 px-4 py-2 rounded-full font-semibold text-white/90 bg-black/30 border border-white/10 hover:border-gold/60 hover:bg-black/40 transition">
        Logout
      </button>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-12">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- LEFT: PROFILE -->
        <section class="lg:col-span-5 rounded-2xl border border-gold/15 bg-black/30 p-6">
          <div
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-gold/25 bg-black/30 shadow-[0_0_18px_rgba(201,161,74,.10)]">
            <span class="w-2 h-2 rounded-full bg-gold"></span>
            <span class="text-gold-soft text-xs">Logged in</span>
          </div>

          <h1 class="mt-4 font-playfair text-gold-soft text-[2.0rem] leading-tight">Agent Profile</h1>

          <div class="mt-4 space-y-2 text-sm text-white/70">
            <div><span class="text-white/45">Name:</span> <span id="txtName"
                class="text-gold-soft font-semibold">—</span></div>
            <div><span class="text-white/45">Email:</span> <span id="txtEmail"
                class="text-gold-soft font-semibold">—</span></div>
            <div><span class="text-white/45">Master Agent REF:</span> <span id="txtMARef"
                class="text-gold-soft font-semibold">—</span></div>
          </div>

          <!-- ✅ NEW: MASTER AGENT LANDING PAGE -->
          <div class="mt-5 rounded-2xl border border-gold/15 bg-black/20 p-4">
            <div class="text-[11px] text-white/45 uppercase tracking-wider">Your Master Agent Landing Page</div>
            <a id="txtMALanding" href="#" target="_blank"
              class="mt-2 block text-sm text-white/85 underline underline-offset-4 break-all">—</a>

            <div class="mt-3 flex flex-wrap gap-2">
              <button id="copyMALanding"
                class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
                Copy Link
              </button>
              <button id="shareMALandingWA"
                class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
                Share WhatsApp
              </button>
            </div>
            <div class="mt-2 text-[11px] text-white/45">This is your Master Agent’s official purchase page link.</div>
          </div>

          <div id="alertBox"
            class="hidden mt-5 rounded-2xl border border-gold/20 bg-black/30 p-4 text-sm text-white/80"></div>

          <div class="mt-6 rounded-2xl border border-gold/15 bg-black/20 p-4 text-sm text-white/70">
            <div class="font-semibold text-gold-soft">Your job</div>
            <ul class="mt-2 space-y-2">
              <li>• Collect customer details</li>
              <li>• Upload proof of purchase</li>
              <li>• Submit to Admin for verification</li>
            </ul>
          </div>
        </section>

        <!-- RIGHT: SUBMISSION -->
        <section
          class="lg:col-span-7 rounded-2xl border border-gold/15 bg-[linear-gradient(180deg,#101010,#060606)] shadow-[0_0_25px_rgba(0,0,0,.6)] p-6">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-playfair text-gold-soft text-[1.6rem]">Submit Customer Purchase</h2>
            <div class="text-xs text-white/45">Neon DB + Google Drive</div>
          </div>

          <form id="submissionForm" class="mt-5 space-y-4">
            <input id="f_ma_ref" type="hidden" value="" />
            <input id="f_agent_email" type="hidden" value="" />
            <input id="f_agent_name" type="hidden" value="" />

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-xs text-white/60">Customer Name</label>
                <input name="customer_name" required
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="e.g. Siti Nurhaliza" />
              </div>
              <div>
                <label class="text-xs text-white/60">Customer WhatsApp</label>
                <input name="customer_whatsapp" required inputmode="numeric"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="e.g. 60123456789" />
              </div>
            </div>

            <div>
              <label class="text-xs text-white/60">Customer Address</label>
              <textarea name="customer_address" rows="3" required
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                placeholder="Full address"></textarea>
            </div>

            <!-- PRODUCT -->
            <div class="rounded-2xl soft-border bg-black/20 p-4">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-xs text-white/60">Product</div>
                  <div class="mt-1 text-sm text-white/70">Select item and quantity. Price is fixed.</div>
                </div>
                <div class="text-xs text-white/45">Auto-calc amount</div>
              </div>

              <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="cursor-pointer rounded-2xl soft-border bg-black/25 p-4 hover:border-gold/50 transition">
                  <input type="radio" name="product_choice" value="QariLive Lite" class="mr-2 accent-[#c9a14a]" checked />
                  <span class="font-semibold text-white/90">QariLive Lite</span>
                  <div class="mt-1 text-xs text-white/55">RM 1,500 / unit</div>
                </label>

                <label class="cursor-pointer rounded-2xl soft-border bg-black/25 p-4 hover:border-gold/50 transition">
                  <input type="radio" name="product_choice" value="QariLive Azan Clock" class="mr-2 accent-[#c9a14a]" />
                  <span class="font-semibold text-white/90">QariLive Azan Clock</span>
                  <div class="mt-1 text-xs text-white/55">RM 3,000 / unit</div>
                </label>
              </div>

              <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                <div>
                  <label class="text-xs text-white/60">Quantity</label>
                  <input id="qty" name="quantity" type="number" min="1" step="1" value="1" required
                    class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30" />
                </div>

                <div>
                  <label class="text-xs text-white/60">Unit Price (RM)</label>
                  <input id="unitPrice" type="text" readonly
                    class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border text-white/70" />
                </div>

                <div>
                  <label class="text-xs text-white/60">Total Amount (RM)</label>
                  <input id="totalAmount" name="purchase_amount_rm" type="text" readonly
                    class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border text-white/90 font-semibold" />
                </div>
              </div>

              <div class="mt-2 text-[11px] text-white/45">If customer buys more than 1 unit, just increase Quantity.</div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-xs text-white/60">Purchase Date</label>
                <input name="purchase_date" type="date"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30" />
              </div>
              <div>
                <label class="text-xs text-white/60">Notes (optional)</label>
                <input name="notes"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="Any extra notes for Admin" />
              </div>
            </div>

            <div>
              <label class="text-xs text-white/60">Proof of Purchase (Screenshot / Photo)</label>
              <input name="proof_image" type="file" accept="image/*" required
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white/85" />
              <div class="mt-1 text-[11px] text-white/45">Upload 1 clear image (receipt / transfer screenshot).</div>
            </div>

            <button type="submit" id="btnSubmit"
              class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
              Submit to Admin
            </button>

            <div class="text-xs text-white/45">After submit, Admin will verify and confirm. Keep customer contact
              available.</div>
          </form>
        </section>

        <!-- FULL WIDTH: MY SUBMISSIONS -->
        <section class="lg:col-span-12 rounded-2xl glass p-6">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
            <div>
              <h2 class="font-playfair text-gold-soft text-2xl">My Submissions</h2>
              <p class="mt-1 text-sm text-white/60">Only shows submissions created by <span class="text-white/80">your account</span>.</p>
            </div>
            <div class="text-left md:text-right">
              <div class="text-[11px] text-white/45 uppercase tracking-wider">Total</div>
              <div id="mySubCount" class="mt-1 text-3xl font-semibold text-gold-soft">—</div>
            </div>
          </div>

          <div class="mt-4 flex flex-col lg:flex-row lg:items-center gap-3">
            <div class="flex flex-wrap gap-2 items-center">
              <button id="btnRefreshMySubs"
                class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
                Refresh
              </button>
              <div id="mySubsStatus" class="text-sm text-white/55">—</div>
            </div>

            <div class="flex-1"></div>

            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
              <input id="mySubsSearch"
                class="w-full sm:w-[320px] px-4 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30 text-sm"
                placeholder="Search my submissions..." />
              <select id="mySubsPerPage" class="px-3 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white/85 text-sm">
                <option value="5">5 / page</option>
                <option value="10" selected>10 / page</option>
                <option value="20">20 / page</option>
                <option value="50">50 / page</option>
              </select>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto">
            <table id="mySubsTable" class="min-w-full text-sm soft-border rounded-xl overflow-hidden">
              <thead class="bg-black/30">
                <tr class="text-left">
                  <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="customer_name">Customer</th>
                  <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="customer_phone">Phone</th>
                  <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="product">Product</th>
                  <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="qty">Qty</th>
                  <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="purchase_amount_rm">Amount (RM)</th>
                  <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="status">Status</th>
                  <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="created_at">Submitted</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Proof</th>
                </tr>
              </thead>
              <tbody id="tblMySubs" class="divide-y divide-white/10 bg-black/15">
                <tr><td class="px-4 py-4 text-white/60" colspan="8">Not loaded yet.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mt-4 flex items-center justify-between gap-3">
            <button id="mySubsPrev" class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm">Prev</button>
            <div id="mySubsPageInfo" class="text-sm text-white/55">—</div>
            <button id="mySubsNext" class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm">Next</button>
          </div>
        </section>

        <!-- ✅ NEW: AGENT BANK DETAILS (PRIVATE, NOT VISIBLE TO MASTER AGENT) -->
        <section class="lg:col-span-12 rounded-2xl glass p-6">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
            <div>
              <h2 class="font-playfair text-gold-soft text-2xl">My Bank Details (Private)</h2>
              <p class="mt-1 text-sm text-white/60">
                Only Admin can process payout. Master Agent will <span class="text-white/80">NOT</span> see your bank details.
              </p>
            </div>
            <div class="text-left md:text-right">
              <div class="text-[11px] text-white/45 uppercase tracking-wider">Last updated</div>
              <div id="bankUpdatedAt" class="mt-1 text-sm font-semibold text-gold-soft">—</div>
            </div>
          </div>

          <form id="agentBankForm" class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-white/60">Bank Name</label>
              <input id="bank_name" required
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                placeholder="Maybank / CIMB / etc" />
            </div>

            <div>
              <label class="text-xs text-white/60">Account Holder Name</label>
              <input id="bank_account_name" required
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                placeholder="Name as per bank" />
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-white/60">Account Number</label>
              <input id="bank_account_number" required
                class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                placeholder="Full account number" />
              <div class="mt-1 text-[11px] text-white/45">
                We will mask it after loading. To change, type the full number again.
              </div>
            </div>

            <div class="md:col-span-2">
              <button type="submit" id="btnSaveBank"
                class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
                Save Bank Details
              </button>
              <div class="mt-2 text-[11px] text-white/45">
                Saving uses your Netlify Identity login (JWT). Master Agent dashboard has no access to this data.
              </div>
            </div>
          </form>
        </section>

      </div>
    </div>
  </main>

  <footer class="border-t border-gold/15 bg-black/60">
    <div class="max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center">
      <small class="text-white/45">© 2025 IT People Sdn Bhd • QariLive Operations</small>
    </div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);

    const alertBox = $("alertBox");
    function showAlert(msg, type = "info") {
      alertBox.classList.remove("hidden");
      alertBox.textContent = msg;
      alertBox.classList.remove("border-red-500/25", "bg-red-500/10", "border-gold/20", "bg-black/30");
      if (type === "error") alertBox.classList.add("border-red-500/25", "bg-red-500/10");
      else alertBox.classList.add("border-gold/20", "bg-black/30");
    }
    function hideAlert() { alertBox.classList.add("hidden"); alertBox.textContent = ""; }
    function safeRedirect(url) { window.location.href = url; }

    function waitForIdentity() {
      return new Promise((resolve) => {
        const tick = () => window.netlifyIdentity ? resolve(window.netlifyIdentity) : setTimeout(tick, 50);
        tick();
      });
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function fmtDate(iso){
      if (!iso) return "—";
      try{ const d = new Date(iso); if (isNaN(d.getTime())) return "—"; return d.toLocaleString(); }
      catch{ return "—"; }
    }

    // Notes meta parsing (from agent-submission-create)
    function parseMetaFromNotes(notes){
      const out = { product:"—", qty:"—", unit:"—" };
      const s = String(notes || "");
      const mProd = s.match(/\[QL_PRODUCT\]=([^;]+);/);
      const mQty  = s.match(/\[QL_QTY\]=([^;]+);/);
      const mUnit = s.match(/\[QL_UNIT\]=([^;]+);/);
      if (mProd) out.product = mProd[1].trim();
      if (mQty) out.qty = mQty[1].trim();
      if (mUnit) out.unit = mUnit[1].trim();
      return out;
    }

    // ---- Simple DataTable (client-side) ----
    function makeDataTable(opts){
      const {
        tableId, tbodyId, searchId, perPageId, prevId, nextId, pageInfoId,
        emptyMessage, columns
      } = opts;

      const table = $(tableId);
      const tbody = $(tbodyId);
      const search = $(searchId);
      const perPage = $(perPageId);
      const prevBtn = $(prevId);
      const nextBtn = $(nextId);
      const pageInfo = $(pageInfoId);

      let raw = [];
      let filtered = [];
      let page = 1;
      let pageSize = Number(perPage?.value || 10);
      let sortKey = null;
      let sortDir = "desc";
      const sortIcons = { asc:"▲", desc:"▼" };

      function getCellText(col, row){
        if (col.text) return String(col.text(row) ?? "");
        const v = row?.[col.key];
        return v == null ? "" : String(v);
      }
      function rowSearchText(row){
        return columns.map(c => getCellText(c,row)).join(" ").toLowerCase();
      }
      function applyFilter(){
        const q = String(search?.value || "").trim().toLowerCase();
        filtered = !q ? raw.slice() : raw.filter(r => rowSearchText(r).includes(q));
      }
      function applySort(){
        if (!sortKey) return;
        const col = columns.find(c => (c.sortKey || c.key) === sortKey);
        const getter = col?.sortValue ? (r)=>col.sortValue(r) : (r)=>getCellText(col || {key:sortKey}, r);

        filtered.sort((a,b)=>{
          const av = getter(a); const bv = getter(b);
          const an = typeof av==="number" ? av : Number(av);
          const bn = typeof bv==="number" ? bv : Number(bv);
          const bothNumeric = !Number.isNaN(an) && !Number.isNaN(bn);
          let res;
          if (bothNumeric) res = an - bn;
          else res = String(av ?? "").localeCompare(String(bv ?? ""), undefined, {numeric:true, sensitivity:"base"});
          return sortDir==="asc" ? res : -res;
        });
      }
      function totalPages(){ return Math.max(1, Math.ceil(filtered.length / pageSize)); }
      function clampPage(){ const tp = totalPages(); page = Math.min(Math.max(page,1),tp); }
      function updateHeaderIcons(){
        table?.querySelectorAll("thead th.sortable").forEach(th=>{
          const key = th.getAttribute("data-key");
          const base = th.getAttribute("data-label") || th.textContent.replace(/ ▲| ▼/g,"").trim();
          th.setAttribute("data-label", base);
          th.textContent = (key===sortKey) ? (base + " " + (sortDir==="asc"?sortIcons.asc:sortIcons.desc)) : base;
        });
      }
      function render(){
        pageSize = Number(perPage?.value || 10) || 10;
        applyFilter(); applySort(); clampPage();
        const tp = totalPages();
        const start = (page-1)*pageSize;
        const slice = filtered.slice(start, start+pageSize);

        if (!slice.length){
          tbody.innerHTML = `<tr><td class="px-4 py-4 text-white/60" colspan="${columns.length}">${escapeHtml(emptyMessage || "No results.")}</td></tr>`;
        } else {
          tbody.innerHTML = slice.map(row=>{
            const tds = columns.map(col=>{
              const html = col.render ? col.render(row) : escapeHtml(getCellText(col,row) || "—");
              return `<td class="px-4 py-3 ${col.tdClass || "text-white/75"}">${html}</td>`;
            }).join("");
            return `<tr>${tds}</tr>`;
          }).join("");
        }
        pageInfo.textContent = `Page ${page} / ${tp} • ${filtered.length} result(s)`;
        prevBtn.disabled = page<=1;
        nextBtn.disabled = page>=tp;
        prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
        nextBtn.classList.toggle("opacity-50", nextBtn.disabled);
        updateHeaderIcons();
      }
      function setData(rows){ raw = Array.isArray(rows)?rows.slice():[]; page=1; render(); }

      search?.addEventListener("input", ()=>{ page=1; render(); });
      perPage?.addEventListener("change", ()=>{ page=1; render(); });
      prevBtn?.addEventListener("click", ()=>{ page-=1; render(); });
      nextBtn?.addEventListener("click", ()=>{ page+=1; render(); });
      table?.querySelectorAll("thead th.sortable").forEach(th=>{
        th.addEventListener("click", ()=>{
          const key = th.getAttribute("data-key");
          if (!key) return;
          if (sortKey===key) sortDir = (sortDir==="asc"?"desc":"asc");
          else { sortKey=key; sortDir="asc"; }
          page=1; render();
        });
      });

      return { setData, render, setSort:(key,dir="desc")=>{ sortKey=key; sortDir=dir; render(); } };
    }

    async function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function agentUpsert(identity, payload) {
      try {
        const u = identity.currentUser();
        if (!u) return;
        const token = await u.jwt();
        await fetch("/.netlify/functions/agent-upsert", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify(payload)
        });
      } catch (e) {
        console.warn("agent-upsert failed:", e);
      }
    }

    // ✅ NEW: Master Agent landing helpers
    function openWhatsAppWithText(text){
      window.open("https://wa.me/?text=" + encodeURIComponent(text || ""), "_blank");
    }
    function copyToClipboard(text){
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        showAlert("Copied to clipboard.");
        setTimeout(hideAlert, 1200);
      }).catch(() => showAlert("Copy failed. Please copy manually.", "error"));
    }

    // ✅ NEW: Agent bank (private) helpers
    async function getAuthHeader(identity){
      const u = identity.currentUser();
      if (!u) return {};
      const token = await u.jwt();
      return { "Authorization": "Bearer " + token };
    }
    function maskAccount(acc){
      if (!acc) return "";
      const s = String(acc);
      if (s.length <= 4) return "****";
      return "**** **** " + s.slice(-4);
    }
    let lastRealBankAccount = "";

    async function loadAgentBank(identity){
      try{
        const auth = await getAuthHeader(identity);
        const res = await fetch("/.netlify/functions/agent-payout-get?t=" + Date.now(), {
          method:"GET",
          headers: { ...auth }
        });
        const out = await res.json().catch(()=>({}));
        if (!res.ok || !out.ok) return;

        const d = out.data || null;
        if (!d) {
          $("bankUpdatedAt").textContent = "—";
          return;
        }

        $("bank_name").value = d.bank_name || "";
        $("bank_account_name").value = d.bank_account_name || "";
        lastRealBankAccount = d.bank_account_number || "";
        $("bank_account_number").value = lastRealBankAccount ? maskAccount(lastRealBankAccount) : "";
        $("bankUpdatedAt").textContent = d.updated_at ? fmtDate(d.updated_at) : "—";
      }catch(e){
        console.error(e);
      }
    }

    function resolveAccountToSave(){
      const val = ($("bank_account_number").value || "").trim();
      if (!val) return "";
      if (val.includes("*")) return lastRealBankAccount || "";
      return val;
    }

    async function saveAgentBank(identity){
      const auth = await getAuthHeader(identity);

      const payload = {
        bank_name: ($("bank_name").value || "").trim(),
        bank_account_name: ($("bank_account_name").value || "").trim(),
        bank_account_number: resolveAccountToSave()
      };

      const res = await fetch("/.netlify/functions/agent-payout-set", {
        method:"POST",
        headers: { "Content-Type":"application/json", ...auth },
        body: JSON.stringify(payload)
      });

      const out = await res.json().catch(()=>({}));
      if (!res.ok || !out.ok) throw new Error(out.error || "Failed to save bank details.");

      lastRealBankAccount = payload.bank_account_number;
      $("bank_account_number").value = lastRealBankAccount ? maskAccount(lastRealBankAccount) : "";
      $("bankUpdatedAt").textContent = fmtDate(new Date().toISOString());
    }

    // Product config
    const PRODUCTS = {
      "QariLive Lite": 1500,
      "QariLive Azan Clock": 3000,
    };

    function getSelectedProduct(){
      const el = document.querySelector('input[name="product_choice"]:checked');
      return el ? el.value : "QariLive Lite";
    }
    function calcTotals(){
      const product = getSelectedProduct();
      const unit = PRODUCTS[product] || 0;
      const qty = Math.max(1, Number($("qty").value || 1));
      const total = unit * qty;

      $("unitPrice").value = unit ? unit.toLocaleString("en-MY") : "";
      $("totalAmount").value = total ? total.toLocaleString("en-MY") : "";
      return { product, unit, qty, total };
    }

    function setMySubsStatus(text){ $("mySubsStatus").textContent = text || "—"; }

    const mySubsDT = makeDataTable({
      tableId: "mySubsTable",
      tbodyId: "tblMySubs",
      searchId: "mySubsSearch",
      perPageId: "mySubsPerPage",
      prevId: "mySubsPrev",
      nextId: "mySubsNext",
      pageInfoId: "mySubsPageInfo",
      emptyMessage: "No submissions yet.",
      columns: [
        { key:"customer_name", tdClass:"text-white/85", text:(r)=>r.customer_name||"—" },
        { key:"customer_phone", tdClass:"text-white/75", text:(r)=>r.customer_phone||"—" },
        { key:"product", tdClass:"text-white/75", text:(r)=>parseMetaFromNotes(r.notes).product },
        { key:"qty", tdClass:"text-white/75", text:(r)=>parseMetaFromNotes(r.notes).qty, sortValue:(r)=>Number(parseMetaFromNotes(r.notes).qty)||0 },
        { key:"purchase_amount_rm", tdClass:"text-white/75", text:(r)=> (r.purchase_amount_rm ?? "—"), sortValue:(r)=>Number(r.purchase_amount_rm)||0 },
        { key:"status", tdClass:"text-white/60", text:(r)=>r.status||"pending" },
        { key:"created_at", tdClass:"text-white/60", text:(r)=>fmtDate(r.created_at), sortValue:(r)=>new Date(r.created_at||0).getTime() },
        { key:"proof_url", tdClass:"text-white/75", render:(r)=> {
            const url = r.proof_url || "";
            return url ? `<a class="underline underline-offset-4 text-white/85" target="_blank" href="${escapeHtml(url)}">View</a>` : "—";
          }, text:(r)=>r.proof_url||"" },
      ]
    });
    mySubsDT.setSort("created_at","desc");

    async function loadMySubmissions(identity){
      try{
        setMySubsStatus("Loading...");
        $("mySubCount").textContent = "—";
        mySubsDT.setData([]);

        const u = identity.currentUser();
        if (!u) return safeRedirect("agent-auth.html");
        const token = await u.jwt();

        const res = await fetch("/.netlify/functions/agent-submissions-self?t=" + Date.now(), {
          method:"GET",
          headers:{ "Authorization": "Bearer " + token }
        });

        const out = await res.json().catch(()=>({}));
        if (!res.ok || !out.ok) throw new Error(out.error || ("HTTP " + res.status));

        $("mySubCount").textContent = String(out.count ?? (out.submissions?.length ?? 0));
        mySubsDT.setData(out.submissions || []);
        setMySubsStatus("Updated: " + new Date().toLocaleTimeString());
      }catch(e){
        console.error(e);
        setMySubsStatus("Failed to load.");
        $("mySubCount").textContent = "—";
        mySubsDT.setData([]);
      }
    }

    async function init() {
      const identity = await waitForIdentity();
      identity.init();

      const u = identity.currentUser();
      if (!u) return safeRedirect("agent-auth.html");

      const meta = u.user_metadata || {};
      const email = u.email || "—";
      const name = meta.full_name || (email.includes("@") ? email.split("@")[0] : "Agent");

      const parent = String(
        meta.ma_code ||
        meta.parent_ma_code ||
        meta.ma_ref ||
        (meta.data && meta.data.ma_code) ||
        (meta.data && meta.data.parent_ma_code) ||
        ""
      ).toUpperCase().trim();

      $("txtEmail").textContent = email;
      $("txtName").textContent = name;
      $("txtMARef").textContent = parent || "—";

      $("f_ma_ref").value = parent || "";
      $("f_agent_email").value = email || "";
      $("f_agent_name").value = name || "";

      // ✅ NEW: master agent landing url (change LANDING_FILE if your page name differs)
      const LANDING_FILE = "master-agent-landing.html";
      const base = window.location.origin.replace(/\/$/,"") + "/";
      const maLanding = parent ? (base + LANDING_FILE + "?ref=" + encodeURIComponent(parent)) : "";
      const a = $("txtMALanding");
      a.textContent = maLanding || "—";
      a.href = maLanding || "#";
      $("copyMALanding").onclick = () => maLanding && copyToClipboard(maLanding);
      $("shareMALandingWA").onclick = () => {
        if (!maLanding) return;
        openWhatsAppWithText("Hi! This is my Master Agent’s official QariLive purchase link:\n" + maLanding);
      };

      // ✅ make sure agent exists in Neon (agents table)
      await agentUpsert(identity, {
        ma_code: parent,
        full_name: name,
        whatsapp: meta.whatsapp || "",
        email: email
      });

      // init product calc
      document.querySelectorAll('input[name="product_choice"]').forEach(el => el.addEventListener("change", calcTotals));
      $("qty").addEventListener("input", calcTotals);
      calcTotals();

      const url = new URL(window.location.href);
      if (url.searchParams.get("success") === "1") {
        showAlert("✅ Submitted successfully. Admin will review soon.");
      }

      $("btnLogout").addEventListener("click", async () => {
        try { await identity.logout(); }
        finally { safeRedirect("agent-auth.html"); }
      });

      $("btnRefreshMySubs").addEventListener("click", () => loadMySubmissions(identity));

      // ✅ NEW: load agent bank
      await loadAgentBank(identity);

      // ✅ NEW: save agent bank
      $("agentBankForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        hideAlert();
        const btn = $("btnSaveBank");
        const old = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Saving...";

        try{
          await saveAgentBank(identity);
          showAlert("✅ Bank details saved (private).");
          setTimeout(hideAlert, 1400);
        }catch(err){
          console.error(err);
          showAlert(err?.message || "Save failed.", "error");
        }finally{
          btn.disabled = false;
          btn.textContent = old;
        }
      });

      // Load my submissions on open
      await loadMySubmissions(identity);

      const form = $("submissionForm");
      const btn = $("btnSubmit");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideAlert();

        try {
          btn.disabled = true;
          btn.textContent = "Submitting...";

          const uu = identity.currentUser();
          if (!uu) return safeRedirect("agent-auth.html");
          const token = await uu.jwt();

          const fd = new FormData(form);
          const proofFile = form.querySelector('input[name="proof_image"]').files?.[0];
          if (!proofFile) { showAlert("Please upload proof image.", "error"); return; }

          const proof_data_url = await fileToDataUrl(proofFile);

          const totals = calcTotals();

          const payload = {
            ma_code: $("f_ma_ref").value || "",
            agent_email: $("f_agent_email").value || "",
            agent_name: $("f_agent_name").value || "",
            customer_name: fd.get("customer_name") || "",
            customer_phone: fd.get("customer_whatsapp") || "",
            customer_address: fd.get("customer_address") || "",
            product_name: totals.product,
            quantity: totals.qty,
            unit_price_rm: totals.unit,
            purchase_amount_rm: String(totals.total),
            purchase_date: fd.get("purchase_date") || "",
            notes: fd.get("notes") || "",
            proof_data_url,
            proof_filename: proofFile.name || "proof.jpg",
          };

          const res = await fetch("/.netlify/functions/agent-submission-create", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify(payload),
          });

          const out = await res.json().catch(() => ({}));
          if (!res.ok || !out.ok) throw new Error(out.error || ("Submit failed (HTTP " + res.status + ")"));

          showAlert("✅ Submitted successfully. Admin will review soon.");
          form.reset();
          $("qty").value = "1";
          document.querySelector('input[name="product_choice"][value="QariLive Lite"]').checked = true;
          calcTotals();

          // refresh table
          await loadMySubmissions(identity);

        } catch (err) {
          console.error(err);
          showAlert(err?.message || "Submit failed.", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "Submit to Admin";
        }
      });
    }

    init();
  </script>
</body>

</html>
