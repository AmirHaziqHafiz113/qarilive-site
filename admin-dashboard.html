<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | QariLive</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Charts (CDN, no build step) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { gold: '#c9a14a', 'gold-soft': '#f5e6b3', blackish: '#050505', darkish: '#0b0b0b' },
          fontFamily: { inter: ['Inter', 'sans-serif'], playfair: ['Playfair Display', 'serif'] },
          boxShadow: { goldGlow: '0 0 34px rgba(201,161,74,.22)' }
        }
      }
    }
  </script>

  <style>
    body {
      background: radial-gradient(circle at top, #121212, #000 70%);
    }

    .soft-border {
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .focus-gold:focus {
      outline: none;
      border-color: rgba(201, 161, 74, .65);
      box-shadow: 0 0 0 4px rgba(201, 161, 74, .12);
    }

    .glass {
      background: rgba(0, 0, 0, .30);
      border: 1px solid rgba(201, 161, 74, .15);
    }

    canvas {
      background: rgba(0, 0, 0, .12);
      border-radius: 16px;
    }
  </style>
</head>

<body class="m-0 font-inter text-white/90 min-h-screen flex flex-col">

  <header class="sticky top-0 z-50 backdrop-blur bg-black/55 border-b border-gold/15">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <a href="index.html" class="no-underline flex items-center gap-2 min-w-0">
          <span class="font-playfair text-gold-soft text-lg md:text-xl whitespace-nowrap">QariLive™</span>
          <span class="hidden sm:inline-block text-xs text-white/45 truncate">Admin Dashboard</span>
        </a>
      </div>

      <div class="flex items-center gap-2">
        <div class="hidden md:block text-xs text-white/45">
          <span id="adminEmail">—</span>
        </div>
        <button id="btnLogout"
          class="px-4 py-2 rounded-full font-semibold text-white/90 bg-black/30 border border-white/10 hover:border-gold/60 hover:bg-black/40 transition">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-12 space-y-6">

      <div id="alertBox" class="hidden rounded-2xl border border-gold/20 bg-black/30 p-4 text-sm text-white/80"></div>

      <!-- KPI -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl glass p-5">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Total Users (Identity)</div>
          <div id="kpiTotalUsers" class="mt-2 text-3xl font-semibold text-gold-soft">—</div>
          <div class="mt-1 text-xs text-white/45">From Identity Admin API</div>
        </div>
        <div class="rounded-2xl glass p-5">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Total Agents</div>
          <div id="kpiTotalAgents" class="mt-2 text-3xl font-semibold text-gold-soft">—</div>
          <div class="mt-1 text-xs text-white/45">From Identity role=agent</div>
        </div>
        <div class="rounded-2xl glass p-5">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Top Master Agent</div>
          <div id="kpiTopMA" class="mt-2 text-xl font-semibold text-gold-soft">—</div>
          <div class="mt-1 text-xs text-white/45">Highest agent count</div>
        </div>
      </section>

      <!-- CHARTS -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-2xl glass p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-playfair text-gold-soft text-xl">Agents by Master Agent</h2>
            <button id="btnRefreshAnalytics"
              class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
              Refresh
            </button>
          </div>
          <div class="mt-4">
            <canvas id="chartAgentsByMA" height="240"></canvas>
          </div>
          <div id="analyticsStatus" class="mt-3 text-sm text-white/55">—</div>
        </div>

        <div class="rounded-2xl glass p-5">
          <h2 class="font-playfair text-gold-soft text-xl">Earnings Overview</h2>
          <p class="mt-1 text-sm text-white/60">
            Placeholder (you can extend later to aggregate earnings).
          </p>
          <div class="mt-4">
            <canvas id="chartEarnings" height="240"></canvas>
          </div>
          <div class="mt-3 text-sm text-white/55" id="earningsStatus">—</div>
        </div>
      </section>

      <!-- USERS (VERTICAL + PAGINATION) -->
      <section class="rounded-2xl glass p-6">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <h2 class="font-playfair text-gold-soft text-2xl">Manage Master Agents & Agents</h2>
            <p class="mt-1 text-sm text-white/60">Create / disable / delete Identity users (Admin-only).</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="btnLoadUsers"
              class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
              Load Users
            </button>
          </div>
        </div>

        <!-- vertical stack -->
        <div class="mt-5 space-y-4">

          <!-- Create -->
          <div class="rounded-2xl border border-gold/15 bg-black/20 p-5">
            <div class="text-sm font-semibold text-gold-soft">Create New User</div>
            <p class="mt-1 text-xs text-white/55">Admin creates accounts (no public registration).</p>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/60">Role</label>
                <select id="newRole"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white/85">
                  <option value="master_agent">master_agent</option>
                  <option value="agent">agent</option>
                </select>
              </div>

              <div>
                <label class="text-xs text-white/60">Email</label>
                <input id="newEmail" type="email"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="user@email.com" />
              </div>

              <div>
                <label class="text-xs text-white/60">Full Name</label>
                <input id="newName" type="text"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="Full name" />
              </div>

              <div id="newParentWrap">
                <label class="text-xs text-white/60">Parent Master Agent REF (for agent)</label>
                <input id="newParentMA" type="text"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="e.g. A15261" />
              </div>

              <div class="md:col-span-2">
                <button id="btnCreateUser"
                  class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
                  Create User (Invite)
                </button>
                <div class="mt-2 text-[11px] text-white/45">
                  Uses: <span class="text-white/80">/.netlify/functions/user-create</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="rounded-2xl border border-gold/15 bg-black/20 p-5 overflow-x-auto">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div class="text-sm font-semibold text-gold-soft">Users</div>

              <div class="flex flex-col sm:flex-row sm:items-center gap-2 w-full md:w-auto">
                <input id="userSearch"
                  class="w-full sm:w-[320px] px-4 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30 text-sm"
                  placeholder="Search email / role / name..." />

                <div class="flex items-center gap-2">
                  <span class="text-xs text-white/45">Rows</span>
                  <select id="userPageSize"
                    class="px-3 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white/85 text-sm">
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                  </select>
                </div>
              </div>
            </div>

            <table class="mt-4 min-w-full text-sm soft-border rounded-xl overflow-hidden">
              <thead class="bg-black/30">
                <tr class="text-left">
                  <th class="px-4 py-3 text-white/70 font-semibold">Role</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Email</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Name</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Parent MA</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody id="tblUsers" class="divide-y divide-white/10 bg-black/15">
                <tr>
                  <td class="px-4 py-4 text-white/60" colspan="5">Not loaded yet.</td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination controls -->
            <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div id="userPageInfo" class="text-xs text-white/55">—</div>
              <div class="flex items-center gap-2">
                <button id="btnUserPrev"
                  class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
                  Prev
                </button>
                <button id="btnUserNext"
                  class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
                  Next
                </button>
              </div>
            </div>

            <div class="mt-3 text-xs text-white/45">
              Uses: <span class="text-white/80">users-list</span>, <span class="text-white/80">user-disable</span>,
              <span class="text-white/80">user-delete</span>
            </div>
          </div>

        </div>
      </section>

      <!-- PAYOUT (VERTICAL) -->
      <section class="rounded-2xl glass p-6">
        <div>
          <h2 class="font-playfair text-gold-soft text-2xl">Payouts & Bank Details</h2>
          <p class="mt-1 text-sm text-white/60">Lookup → earnings + bank → generate payout batch.</p>
        </div>

        <!-- vertical stack -->
        <div class="mt-5 space-y-4">
          <!-- Lookup -->
          <div class="rounded-2xl border border-gold/15 bg-black/20 p-5">
            <div class="text-sm font-semibold text-gold-soft">Lookup</div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/60">Type</label>
                <select id="payType"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white/85">
                  <option value="master_agent">Master Agent</option>
                  <option value="agent">Agent</option>
                </select>
              </div>

              <div>
                <label class="text-xs text-white/60">Identifier</label>
                <input id="payId" type="text"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="Master Agent REF or Agent user_id" />
                <div class="mt-1 text-[11px] text-white/45">
                  Master Agent: use <span class="text-white/80">ma_code</span> (e.g. A15261). Agent: use <span
                    class="text-white/80">agent_user_id</span>.
                </div>
              </div>

              <div class="md:col-span-2">
                <button id="btnLoadPayout"
                  class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
                  Load Earnings + Bank
                </button>

                <div class="mt-2 text-[11px] text-white/45">
                  Uses: <span class="text-white/80">earnings-one</span>, <span class="text-white/80">bank-one</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Details -->
          <div class="rounded-2xl border border-gold/15 bg-black/20 p-5">
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm font-semibold text-gold-soft">Details</div>
              <div id="payStatus" class="text-sm text-white/55">—</div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="rounded-2xl soft-border bg-black/20 p-4">
                <div class="text-[11px] text-white/45 uppercase tracking-wider">Total Approved Sales</div>
                <div id="earnedTotal" class="mt-2 text-2xl font-semibold text-gold-soft">—</div>
                <div class="mt-1 text-xs text-white/45">Sum of approved submissions.</div>
              </div>

              <div class="rounded-2xl soft-border bg-black/20 p-4">
                <div class="text-[11px] text-white/45 uppercase tracking-wider">Commission %</div>
                <input id="commissionPct" type="number" min="0" max="100" step="0.1"
                  class="mt-2 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="e.g. 10" />
                <div class="mt-1 text-xs text-white/45">Used when creating payout batch.</div>
              </div>

              <div class="md:col-span-2 rounded-2xl soft-border bg-black/20 p-4">
                <div class="text-[11px] text-white/45 uppercase tracking-wider">Bank Details</div>
                <div class="mt-2 text-sm text-white/80">
                  <div><span class="text-white/45">Bank:</span> <span id="bankBank">—</span></div>
                  <div><span class="text-white/45">Account Name:</span> <span id="bankName">—</span></div>
                  <div><span class="text-white/45">Account Number:</span> <span id="bankAcc">—</span></div>
                </div>
              </div>

              <div class="md:col-span-2">
                <button id="btnCreatePayoutBatch"
                  class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
                  Create Payout Batch (Export CSV)
                </button>
                <div class="mt-2 text-[11px] text-white/45">
                  Uses: <span class="text-white/80">payout-batch-create</span>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="border-t border-gold/15 bg-black/60">
    <div class="max-w-[1100px] mx-auto px-4 sm:px-6 py-10 text-center">
      <div class="flex flex-col items-center gap-4">
        <img src="images/our_logo.jpg" alt="IT People Sdn Bhd"
          class="w-[180px] sm:w-[220px] md:w-[260px] max-w-full h-auto opacity-90" />
        <small class="text-white/45">© 2025 IT People Sdn Bhd • QariLive Operations</small>
      </div>
    </div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);

    const alertBox = $("alertBox");
    function showAlert(msg, type = "info") {
      alertBox.classList.remove("hidden");
      alertBox.textContent = msg;
      alertBox.classList.remove("border-red-500/25", "bg-red-500/10", "border-gold/20", "bg-black/30");
      if (type === "error") alertBox.classList.add("border-red-500/25", "bg-red-500/10");
      else alertBox.classList.add("border-gold/20", "bg-black/30");
    }
    function hideAlert() { alertBox.classList.add("hidden"); alertBox.textContent = ""; }

    function waitForIdentity() {
      return new Promise((resolve) => {
        const t = () => window.netlifyIdentity ? resolve(window.netlifyIdentity) : setTimeout(t, 50);
        t();
      });
    }

    async function requireAdmin(identity) {
      identity.init();
      const u = identity.currentUser();
      if (!u) { window.location.href = "admin-login.html"; return null; }

      const metaRole = String(u.user_metadata?.role || "").toLowerCase();
      const appRoles = u.app_metadata?.roles || [];
      const isAdmin = metaRole === "admin" || (Array.isArray(appRoles) && appRoles.includes("admin"));

      if (!isAdmin) {
        await identity.logout();
        window.location.href = "admin-login.html";
        return null;
      }

      $("adminEmail").textContent = u.email || "admin";
      return u;
    }

    async function authHeader(identity) {
      const u = identity.currentUser();
      if (!u) return {};
      const token = await u.jwt();
      return { "Authorization": "Bearer " + token };
    }

    // Charts
    let chartAgentsByMA = null;
    let chartEarnings = null;

    function renderAgentsByMAChart(items) {
      const labels = (items || []).map(x => x.ma_code);
      const values = (items || []).map(x => Number(x.agent_count || 0));

      const ctx = $("chartAgentsByMA").getContext("2d");
      if (chartAgentsByMA) chartAgentsByMA.destroy();
      chartAgentsByMA = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Agents", data: values }] },
        options: { responsive: true }
      });
    }

    function renderEarningsPlaceholder() {
      const ctx = $("chartEarnings").getContext("2d");
      if (chartEarnings) chartEarnings.destroy();
      chartEarnings = new Chart(ctx, {
        type: "line",
        data: { labels: ["—"], datasets: [{ label: "Earnings (RM)", data: [0] }] },
        options: { responsive: true }
      });
      $("earningsStatus").textContent = "Placeholder";
    }

    async function loadAnalytics(identity) {
      try {
        $("analyticsStatus").textContent = "Loading...";
        const res = await fetch("/.netlify/functions/agent-stats?t=" + Date.now(), {
          method: "GET",
          headers: { ...(await authHeader(identity)) }
        });
        const out = await res.json().catch(() => ({}));

        if (!res.ok || !out.ok) {
          const detail = out?.detail ? (" | detail: " + out.detail) : "";
          throw new Error((out.error || ("HTTP " + res.status)) + detail);
        }

        $("kpiTotalUsers").textContent = String(out.totalUsers ?? "—");
        $("kpiTotalAgents").textContent = String(out.totalAgents ?? "—");

        const top = (out.byMasterAgent || [])[0];
        $("kpiTopMA").textContent = top ? (top.ma_code + " (" + top.agent_count + ")") : "—";

        renderAgentsByMAChart(out.byMasterAgent || []);
        $("analyticsStatus").textContent = "Updated: " + new Date().toLocaleTimeString();
      } catch (e) {
        console.error(e);
        $("analyticsStatus").textContent = "Failed to load analytics.";
        showAlert(e?.message || "Failed to load analytics.", "error");
      }
    }

    // Users
    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    let cachedUsers = [];

    // Pagination state
    let userPage = 1;
    let userPageSize = 10;

    function getFilteredUsers(list) {
      const q = String($("userSearch").value || "").trim().toLowerCase();
      return (list || []).filter(u => {
        if (!q) return true;
        const hay = (u.role + " " + u.email + " " + u.name + " " + (u.parent_ma || "")).toLowerCase();
        return hay.includes(q);
      });
    }

    function renderUsersTable(list) {
      const tbody = $("tblUsers");
      const filtered = getFilteredUsers(list);

      userPageSize = Number($("userPageSize").value || 10) || 10;

      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / userPageSize));
      if (userPage > totalPages) userPage = totalPages;
      if (userPage < 1) userPage = 1;

      const start = (userPage - 1) * userPageSize;
      const end = start + userPageSize;
      const rows = filtered.slice(start, end);

      if (!rows.length) {
        tbody.innerHTML = `<tr><td class="px-4 py-4 text-white/60" colspan="5">No users.</td></tr>`;
      } else {
        tbody.innerHTML = rows.map(u => {
          const role = escapeHtml(u.role || "—");
          const email = escapeHtml(u.email || "—");
          const name = escapeHtml(u.name || "—");
          const parent = escapeHtml(u.parent_ma || "—");
          const id = escapeHtml(u.id || "");

          return `
            <tr>
              <td class="px-4 py-3 text-white/80">${role}</td>
              <td class="px-4 py-3 text-white/75">${email}</td>
              <td class="px-4 py-3 text-white/75">${name}</td>
              <td class="px-4 py-3 text-white/60">${parent}</td>
              <td class="px-4 py-3 text-white/75">
                <div class="flex flex-wrap gap-2">
                  <button class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm"
                    onclick="window.__disableUser('${id}')">Disable</button>
                  <button class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm"
                    onclick="window.__deleteUser('${id}')">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join("");
      }

      const shownStart = total === 0 ? 0 : (start + 1);
      const shownEnd = Math.min(end, total);

      $("userPageInfo").textContent =
        `Showing ${shownStart}-${shownEnd} of ${total} • Page ${userPage}/${totalPages}`;

      $("btnUserPrev").disabled = userPage <= 1;
      $("btnUserNext").disabled = userPage >= totalPages;

      $("btnUserPrev").classList.toggle("opacity-50", $("btnUserPrev").disabled);
      $("btnUserNext").classList.toggle("opacity-50", $("btnUserNext").disabled);
    }

    async function loadUsers(identity) {
      const res = await fetch("/.netlify/functions/users-list?t=" + Date.now(), {
        headers: { ...(await authHeader(identity)) }
      });
      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) {
        const detail = out?.detail ? (" | detail: " + out.detail) : "";
        throw new Error((out.error || ("HTTP " + res.status)) + detail);
      }

      cachedUsers = out.users || [];
      userPage = 1; // reset on reload
      renderUsersTable(cachedUsers);
    }

    async function createUser(identity) {
      const role = ($("newRole").value || "").trim();
      const email = ($("newEmail").value || "").trim().toLowerCase();
      const name = ($("newName").value || "").trim();
      const parent = ($("newParentMA").value || "").trim().toUpperCase();

      if (!email || !name) throw new Error("Email and name are required.");
      if (role === "agent" && !parent) throw new Error("Agent requires Parent Master Agent REF.");

      const res = await fetch("/.netlify/functions/user-create", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...(await authHeader(identity)) },
        body: JSON.stringify({ role, email, name, parent_ma: parent })
      });

      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) {
        const detail = out?.detail ? (" | detail: " + out.detail) : "";
        throw new Error((out.error || ("HTTP " + res.status)) + detail);
      }

      showAlert("✅ Invite sent. User will set password via email invite link.");
    }

    window.__disableUser = async (id) => {
      try {
        const identity = window.__identity;
        const res = await fetch("/.netlify/functions/user-disable", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...(await authHeader(identity)) },
          body: JSON.stringify({ id })
        });
        const out = await res.json().catch(() => ({}));
        if (!res.ok || !out.ok) {
          const detail = out?.detail ? (" | detail: " + out.detail) : "";
          throw new Error((out.error || "Disable failed.") + detail);
        }
        showAlert("✅ User disabled.");
        await loadUsers(identity);
      } catch (e) { showAlert(e?.message || "Disable failed.", "error"); }
    };

    window.__deleteUser = async (id) => {
      try {
        const identity = window.__identity;
        if (!confirm("Delete user permanently? (Better to disable)")) return;
        const res = await fetch("/.netlify/functions/user-delete", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...(await authHeader(identity)) },
          body: JSON.stringify({ id })
        });
        const out = await res.json().catch(() => ({}));
        if (!res.ok || !out.ok) {
          const detail = out?.detail ? (" | detail: " + out.detail) : "";
          throw new Error((out.error || "Delete failed.") + detail);
        }
        showAlert("✅ User deleted.");
        await loadUsers(identity);
      } catch (e) { showAlert(e?.message || "Delete failed.", "error"); }
    };

    // Payout lookup
    async function loadPayout(identity) {
      const type = ($("payType").value || "").trim();
      const id = ($("payId").value || "").trim();
      if (!id) throw new Error("Identifier is required.");

      $("payStatus").textContent = "Loading...";
      $("earnedTotal").textContent = "—";
      $("bankBank").textContent = "—";
      $("bankName").textContent = "—";
      $("bankAcc").textContent = "—";

      const eRes = await fetch("/.netlify/functions/earnings-one?type=" + encodeURIComponent(type) + "&id=" + encodeURIComponent(id), {
        headers: { ...(await authHeader(identity)) }
      });
      const eOut = await eRes.json().catch(() => ({}));
      if (!eRes.ok || !eOut.ok) throw new Error((eOut.error || "Failed to load earnings.") + (eOut.detail ? (" | detail: " + eOut.detail) : ""));

      const bRes = await fetch("/.netlify/functions/bank-one?type=" + encodeURIComponent(type) + "&id=" + encodeURIComponent(id), {
        headers: { ...(await authHeader(identity)) }
      });
      const bOut = await bRes.json().catch(() => ({}));
      if (!bRes.ok || !bOut.ok) throw new Error((bOut.error || "Failed to load bank details.") + (bOut.detail ? (" | detail: " + bOut.detail) : ""));

      $("earnedTotal").textContent = "RM " + Number(eOut.total_rm || 0).toLocaleString("en-MY");
      $("commissionPct").value = "";

      $("bankBank").textContent = bOut.bank?.bank_name || "—";
      $("bankName").textContent = bOut.bank?.bank_account_name || "—";
      $("bankAcc").textContent = bOut.bank?.bank_account_number || "—";

      $("payStatus").textContent = "Loaded.";
    }

    async function createPayoutBatch(identity) {
      const type = ($("payType").value || "").trim();
      const id = ($("payId").value || "").trim();
      const pct = Number($("commissionPct").value || 0);

      if (!id) throw new Error("Identifier is required.");
      if (Number.isNaN(pct) || pct < 0 || pct > 100) throw new Error("Commission % must be between 0 and 100.");

      const res = await fetch("/.netlify/functions/payout-batch-create", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...(await authHeader(identity)) },
        body: JSON.stringify({ type, id, commission_pct: pct })
      });

      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) {
        const detail = out?.detail ? (" | detail: " + out.detail) : "";
        throw new Error((out.error || "Failed to create payout batch.") + detail);
      }

      showAlert("✅ Payout batch created. Batch ID: " + (out.batch_id || "—"));
    }

    async function init() {
      const identity = await waitForIdentity();
      window.__identity = identity;

      const u = await requireAdmin(identity);
      if (!u) return;

      $("btnLogout").addEventListener("click", async () => {
        try { await identity.logout(); } finally { window.location.href = "admin-login.html"; }
      });

      $("btnRefreshAnalytics").addEventListener("click", () => loadAnalytics(identity));

      $("btnLoadUsers").addEventListener("click", async () => {
        hideAlert();
        try { await loadUsers(identity); }
        catch (e) { showAlert(e?.message || "Failed to load users.", "error"); }
      });

      // Pagination controls
      $("btnUserPrev").addEventListener("click", () => {
        if (userPage > 1) userPage--;
        renderUsersTable(cachedUsers);
      });
      $("btnUserNext").addEventListener("click", () => {
        userPage++;
        renderUsersTable(cachedUsers);
      });
      $("userPageSize").addEventListener("change", () => {
        userPage = 1;
        renderUsersTable(cachedUsers);
      });

      $("userSearch").addEventListener("input", () => {
        userPage = 1;
        renderUsersTable(cachedUsers);
      });

      $("newRole").addEventListener("change", () => {
        const role = $("newRole").value;
        $("newParentWrap").style.display = (role === "agent") ? "block" : "none";
      });
      $("newRole").dispatchEvent(new Event("change"));

      $("btnCreateUser").addEventListener("click", async () => {
        hideAlert();
        const btn = $("btnCreateUser");
        const old = btn.textContent;
        btn.disabled = true; btn.textContent = "Creating...";
        try {
          await createUser(identity);
          $("newEmail").value = "";
          $("newName").value = "";
          $("newParentMA").value = "";
        } catch (e) {
          showAlert(e?.message || "Create user failed.", "error");
        } finally {
          btn.disabled = false; btn.textContent = old;
        }
      });

      $("btnLoadPayout").addEventListener("click", async () => {
        hideAlert();
        try { await loadPayout(identity); }
        catch (e) { showAlert(e?.message || "Load payout failed.", "error"); $("payStatus").textContent = "—"; }
      });

      $("btnCreatePayoutBatch").addEventListener("click", async () => {
        hideAlert();
        const btn = $("btnCreatePayoutBatch");
        const old = btn.textContent;
        btn.disabled = true; btn.textContent = "Creating...";
        try { await createPayoutBatch(identity); }
        catch (e) { showAlert(e?.message || "Create payout batch failed.", "error"); }
        finally { btn.disabled = false; btn.textContent = old; }
      });

      renderEarningsPlaceholder();
      await loadAnalytics(identity);
    }

    init();
  </script>
</body>

</html>