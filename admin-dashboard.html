<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | QariLive</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { gold:'#c9a14a', 'gold-soft':'#f5e6b3', blackish:'#050505', darkish:'#0b0b0b' },
          fontFamily: { inter:['Inter','sans-serif'], playfair:['Playfair Display','serif'] },
          boxShadow: { goldGlow:'0 0 34px rgba(201,161,74,.22)' }
        }
      }
    }
  </script>

  <style>
    body { background: radial-gradient(circle at top, #121212, #000 70%); }
    .soft-border { border: 1px solid rgba(255,255,255,.10); }
    .focus-gold:focus { outline:none; border-color: rgba(201,161,74,.65); box-shadow: 0 0 0 4px rgba(201,161,74,.12); }
    .glass { background: rgba(0,0,0,.30); border: 1px solid rgba(201,161,74,.15); }
    canvas { background: rgba(0,0,0,.12); border-radius: 16px; }
  </style>
</head>

<body class="m-0 font-inter text-white/90 min-h-screen flex flex-col">

  <header class="sticky top-0 z-50 backdrop-blur bg-black/55 border-b border-gold/15">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-3">
      <a href="index.html" class="no-underline flex items-center gap-2 min-w-0">
        <span class="font-playfair text-gold-soft text-lg md:text-xl whitespace-nowrap">QariLive™</span>
        <span class="hidden sm:inline-block text-xs text-white/45 truncate">Admin Dashboard</span>
      </a>

      <div class="flex items-center gap-2">
        <div class="hidden md:block text-xs text-white/45">
          <span id="adminEmail">—</span>
        </div>
        <button id="btnLogout"
          class="px-4 py-2 rounded-full font-semibold text-white/90 bg-black/30 border border-white/10 hover:border-gold/60 hover:bg-black/40 transition">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-12 space-y-6">

      <div id="alertBox" class="hidden rounded-2xl border border-gold/20 bg-black/30 p-4 text-sm text-white/80"></div>

      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl glass p-5">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Total Users (Identity)</div>
          <div id="kpiTotalUsers" class="mt-2 text-3xl font-semibold text-gold-soft">—</div>
        </div>
        <div class="rounded-2xl glass p-5">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Total Agents</div>
          <div id="kpiTotalAgents" class="mt-2 text-3xl font-semibold text-gold-soft">—</div>
        </div>
        <div class="rounded-2xl glass p-5">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Top Master Agent</div>
          <div id="kpiTopMA" class="mt-2 text-xl font-semibold text-gold-soft">—</div>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-2xl glass p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-playfair text-gold-soft text-xl">Agents by Master Agent</h2>
            <button id="btnRefreshAnalytics"
              class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
              Refresh
            </button>
          </div>
          <div class="mt-4">
            <canvas id="chartAgentsByMA" height="240"></canvas>
          </div>
          <div id="analyticsStatus" class="mt-3 text-sm text-white/55">—</div>
        </div>

        <div class="rounded-2xl glass p-5">
          <h2 class="font-playfair text-gold-soft text-xl">Earnings Overview</h2>
          <p class="mt-1 text-sm text-white/60">Placeholder (optional next step).</p>
          <div class="mt-4">
            <canvas id="chartEarnings" height="240"></canvas>
          </div>
          <div class="mt-3 text-sm text-white/55" id="earningsStatus">—</div>
        </div>
      </section>

      <section class="rounded-2xl glass p-6">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <h2 class="font-playfair text-gold-soft text-2xl">Manage Users</h2>
            <p class="mt-1 text-sm text-white/60">Create / disable / delete Identity users.</p>
          </div>
          <button id="btnLoadUsers"
            class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
            Load Users
          </button>
        </div>

        <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="rounded-2xl border border-gold/15 bg-black/20 p-5">
            <div class="text-sm font-semibold text-gold-soft">Create New User</div>

            <div class="mt-4 space-y-3">
              <div>
                <label class="text-xs text-white/60">Role</label>
                <select id="newRole" class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white/85">
                  <option value="master_agent">master_agent</option>
                  <option value="agent">agent</option>
                </select>
              </div>

              <div>
                <label class="text-xs text-white/60">Email</label>
                <input id="newEmail" type="email"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="user@email.com" />
              </div>

              <div>
                <label class="text-xs text-white/60">Full Name</label>
                <input id="newName" type="text"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="Full name" />
              </div>

              <div id="newParentWrap">
                <label class="text-xs text-white/60">Parent Master Agent REF (for agent)</label>
                <input id="newParentMA" type="text"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="e.g. A15261" />
              </div>

              <button id="btnCreateUser"
                class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
                Create User
              </button>

              <div class="text-[11px] text-white/45">
                API: <span class="text-white/80">/.netlify/functions/admin-user-create</span>
              </div>
            </div>
          </div>

          <div class="lg:col-span-2 rounded-2xl border border-gold/15 bg-black/20 p-5 overflow-x-auto">
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm font-semibold text-gold-soft">Users</div>
              <input id="userSearch"
                class="w-[260px] max-w-full px-4 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30 text-sm"
                placeholder="Search..." />
            </div>

            <table class="mt-4 min-w-full text-sm soft-border rounded-xl overflow-hidden">
              <thead class="bg-black/30">
                <tr class="text-left">
                  <th class="px-4 py-3 text-white/70 font-semibold">Role</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Email</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Name</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Parent MA</th>
                  <th class="px-4 py-3 text-white/70 font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody id="tblUsers" class="divide-y divide-white/10 bg-black/15">
                <tr><td class="px-4 py-4 text-white/60" colspan="5">Not loaded yet.</td></tr>
              </tbody>
            </table>

            <div class="mt-3 text-xs text-white/45">
              API: <span class="text-white/80">admin-users-list</span>, <span class="text-white/80">admin-user-disable</span>, <span class="text-white/80">admin-user-delete</span>
            </div>
          </div>
        </div>
      </section>

      <section class="rounded-2xl glass p-6">
        <h2 class="font-playfair text-gold-soft text-2xl">Payouts & Bank Details</h2>

        <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="rounded-2xl border border-gold/15 bg-black/20 p-5">
            <div class="text-sm font-semibold text-gold-soft">Lookup</div>

            <div class="mt-3 space-y-3">
              <div>
                <label class="text-xs text-white/60">Type</label>
                <select id="payType" class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white/85">
                  <option value="master_agent">Master Agent</option>
                  <option value="agent">Agent</option>
                </select>
              </div>

              <div>
                <label class="text-xs text-white/60">Identifier</label>
                <input id="payId" type="text"
                  class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="Master Agent REF (A15261) or Agent user_id" />
              </div>

              <button id="btnLoadPayout"
                class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
                Load Earnings + Bank
              </button>
            </div>
          </div>

          <div class="lg:col-span-2 rounded-2xl border border-gold/15 bg-black/20 p-5">
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm font-semibold text-gold-soft">Details</div>
              <div id="payStatus" class="text-sm text-white/55">—</div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="rounded-2xl soft-border bg-black/20 p-4">
                <div class="text-[11px] text-white/45 uppercase tracking-wider">Sales Total (Approved)</div>
                <div id="earnedTotal" class="mt-2 text-2xl font-semibold text-gold-soft">—</div>
              </div>

              <div class="rounded-2xl soft-border bg-black/20 p-4">
                <div class="text-[11px] text-white/45 uppercase tracking-wider">Commission %</div>
                <input id="commissionPct" type="number" min="0" max="100" step="0.1"
                  class="mt-2 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30"
                  placeholder="e.g. 10" />
              </div>

              <div class="md:col-span-2 rounded-2xl soft-border bg-black/20 p-4">
                <div class="text-[11px] text-white/45 uppercase tracking-wider">Bank Details</div>
                <div class="mt-2 text-sm text-white/80">
                  <div><span class="text-white/45">Bank:</span> <span id="bankBank">—</span></div>
                  <div><span class="text-white/45">Account Name:</span> <span id="bankName">—</span></div>
                  <div><span class="text-white/45">Account Number:</span> <span id="bankAcc">—</span></div>
                </div>
              </div>

              <div class="md:col-span-2">
                <button id="btnCreatePayoutBatch"
                  class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
                  Create Payout Batch (Export)
                </button>
              </div>

              <div class="md:col-span-2">
                <textarea id="payoutCsv" rows="6" readonly
                  class="w-full px-4 py-3 rounded-xl bg-black/25 soft-border text-white/80 text-xs"
                  placeholder="CSV will appear here..."></textarea>
              </div>

            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="border-t border-gold/15 bg-black/60">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center">
      <small class="text-white/45">© 2025 IT People Sdn Bhd • QariLive Operations</small>
    </div>
  </footer>

  <script>
    const $ = (id)=>document.getElementById(id);

    const alertBox = $("alertBox");
    function showAlert(msg, type="info"){
      alertBox.classList.remove("hidden");
      alertBox.textContent = msg;
      alertBox.classList.remove("border-red-500/25","bg-red-500/10","border-gold/20","bg-black/30");
      if (type==="error") alertBox.classList.add("border-red-500/25","bg-red-500/10");
      else alertBox.classList.add("border-gold/20","bg-black/30");
    }
    function hideAlert(){ alertBox.classList.add("hidden"); alertBox.textContent=""; }

    function waitForIdentity(){
      return new Promise((resolve)=>{
        const t=()=>window.netlifyIdentity ? resolve(window.netlifyIdentity) : setTimeout(t,50);
        t();
      });
    }

    function isAdminFromJwt(token){
      try{
        const payload = JSON.parse(atob(token.split(".")[1]));
        const roles = payload?.app_metadata?.roles || [];
        const metaRole = payload?.user_metadata?.role;
        return (Array.isArray(roles) && roles.includes("admin")) || metaRole === "admin";
      }catch{
        return false;
      }
    }

    async function requireAdmin(identity){
      identity.init();
      const u = identity.currentUser();
      if (!u) { window.location.href = "admin-login.html"; return null; }

      const token = await u.jwt();
      if (!isAdminFromJwt(token)){
        await identity.logout();
        window.location.href = "admin-login.html";
        return null;
      }

      $("adminEmail").textContent = u.email || "admin";
      return u;
    }

    async function authHeader(identity){
      const u = identity.currentUser();
      if (!u) return {};
      const token = await u.jwt();
      return { "Authorization": "Bearer " + token };
    }

    async function fetchJson(identity, url, opts={}){
      const res = await fetch(url, {
        ...opts,
        headers: { ...(opts.headers||{}), ...(await authHeader(identity)) }
      });
      const out = await res.json().catch(()=>({}));
      if (!res.ok || !out.ok){
        const detail = out?.error ? (" — " + out.error) : "";
        throw new Error(`API failed: ${url} (HTTP ${res.status})${detail}`);
      }
      return out;
    }

    // Charts
    let chartAgentsByMA = null;
    let chartEarnings = null;

    function renderAgentsByMAChart(items){
      const labels = (items||[]).map(x=>x.ma_code);
      const values = (items||[]).map(x=>Number(x.agent_count||0));
      const ctx = $("chartAgentsByMA").getContext("2d");
      if (chartAgentsByMA) chartAgentsByMA.destroy();
      chartAgentsByMA = new Chart(ctx, {
        type:"bar",
        data:{ labels, datasets:[{ label:"Agents", data: values }] },
        options:{ responsive:true }
      });
    }

    function renderEarningsPlaceholder(){
      const ctx = $("chartEarnings").getContext("2d");
      if (chartEarnings) chartEarnings.destroy();
      chartEarnings = new Chart(ctx, {
        type:"line",
        data:{ labels:[""], datasets:[{ label:"(placeholder)", data:[0] }] },
        options:{ responsive:true }
      });
    }

    async function loadAnalytics(identity){
      $("analyticsStatus").textContent = "Loading...";
      const out = await fetchJson(identity, "/.netlify/functions/admin-agent-stats?t=" + Date.now());
      $("kpiTotalUsers").textContent = String(out.totalUsers ?? "—");
      $("kpiTotalAgents").textContent = String(out.totalAgents ?? "—");

      const top = (out.byMasterAgent||[])[0];
      $("kpiTopMA").textContent = top ? `${top.ma_code} (${top.agent_count})` : "—";

      renderAgentsByMAChart(out.byMasterAgent || []);
      $("analyticsStatus").textContent = "Updated: " + new Date().toLocaleTimeString();
    }

    // User Management
    function escapeHtml(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    let cachedUsers = [];

    function renderUsersTable(list){
      const q = String($("userSearch").value||"").trim().toLowerCase();
      const rows = (list||[]).filter(u=>{
        if (!q) return true;
        const hay = `${u.role||""} ${u.email||""} ${u.name||""} ${u.parent_ma||""}`.toLowerCase();
        return hay.includes(q);
      });

      const tbody = $("tblUsers");
      if (!rows.length){
        tbody.innerHTML = `<tr><td class="px-4 py-4 text-white/60" colspan="5">No users.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(u=>{
        const role = escapeHtml(u.role||"—");
        const email = escapeHtml(u.email||"—");
        const name = escapeHtml(u.name||"—");
        const parent = escapeHtml(u.parent_ma||"—");
        const id = escapeHtml(u.id||"");
        return `
          <tr>
            <td class="px-4 py-3 text-white/80">${role}</td>
            <td class="px-4 py-3 text-white/75">${email}</td>
            <td class="px-4 py-3 text-white/75">${name}</td>
            <td class="px-4 py-3 text-white/60">${parent}</td>
            <td class="px-4 py-3 text-white/75">
              <div class="flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm" data-disable="${id}">Disable</button>
                <button class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm" data-delete="${id}">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      // wire actions
      tbody.querySelectorAll("[data-disable]").forEach(btn=>{
        btn.addEventListener("click", ()=>disableUser(window.__identity, btn.getAttribute("data-disable")));
      });
      tbody.querySelectorAll("[data-delete]").forEach(btn=>{
        btn.addEventListener("click", ()=>deleteUser(window.__identity, btn.getAttribute("data-delete")));
      });
    }

    async function loadUsers(identity){
      const out = await fetchJson(identity, "/.netlify/functions/admin-users-list?t=" + Date.now());
      cachedUsers = out.users || [];
      renderUsersTable(cachedUsers);
    }

    async function createUser(identity){
      const role = ($("newRole").value||"").trim();
      const email = ($("newEmail").value||"").trim().toLowerCase();
      const name = ($("newName").value||"").trim();
      const parent = ($("newParentMA").value||"").trim().toUpperCase();

      if (!email || !name) throw new Error("Email and name are required.");
      if (role === "agent" && !parent) throw new Error("Agent requires Parent Master Agent REF.");

      await fetchJson(identity, "/.netlify/functions/admin-user-create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ role, email, name, parent_ma: parent })
      });

      showAlert("✅ User invited. They must set password from invite email.");
      $("newEmail").value=""; $("newName").value=""; $("newParentMA").value="";
      await loadUsers(identity);
    }

    async function disableUser(identity, id){
      await fetchJson(identity, "/.netlify/functions/admin-user-disable", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id })
      });
      showAlert("✅ User disabled.");
      await loadUsers(identity);
    }

    async function deleteUser(identity, id){
      if (!confirm("Delete user permanently? (Better to disable)")) return;
      await fetchJson(identity, "/.netlify/functions/admin-user-delete", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id })
      });
      showAlert("✅ User deleted.");
      await loadUsers(identity);
    }

    // Payouts
    async function loadPayout(identity){
      const type = ($("payType").value||"").trim();
      const id = ($("payId").value||"").trim();
      if (!id) throw new Error("Identifier is required.");

      $("payStatus").textContent = "Loading...";
      $("earnedTotal").textContent = "—";
      $("bankBank").textContent = "—";
      $("bankName").textContent = "—";
      $("bankAcc").textContent = "—";
      $("payoutCsv").value = "";

      const eOut = await fetchJson(identity, "/.netlify/functions/admin-earnings-one?type=" + encodeURIComponent(type) + "&id=" + encodeURIComponent(id));
      const bOut = await fetchJson(identity, "/.netlify/functions/admin-bank-one?type=" + encodeURIComponent(type) + "&id=" + encodeURIComponent(id));

      $("earnedTotal").textContent = "RM " + Number(eOut.total_rm||0).toLocaleString("en-MY");
      $("commissionPct").value = "";

      $("bankBank").textContent = bOut.bank?.bank_name || "—";
      $("bankName").textContent = bOut.bank?.bank_account_name || "—";
      $("bankAcc").textContent = bOut.bank?.bank_account_number || "—";

      $("payStatus").textContent = "Loaded.";
    }

    async function createPayoutBatch(identity){
      const type = ($("payType").value||"").trim();
      const id = ($("payId").value||"").trim();
      const pct = Number($("commissionPct").value||0);

      if (!id) throw new Error("Identifier is required.");
      if (Number.isNaN(pct) || pct < 0 || pct > 100) throw new Error("Commission % must be between 0 and 100.");

      const out = await fetchJson(identity, "/.netlify/functions/admin-payout-batch-create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ type, id, commission_pct: pct })
      });

      showAlert("✅ Payout batch created: " + (out.batch_id || "—"));
      $("payoutCsv").value = out.csv || "";
    }

    async function init(){
      const identity = await waitForIdentity();
      window.__identity = identity;

      const u = await requireAdmin(identity);
      if (!u) return;

      $("btnLogout").addEventListener("click", async ()=>{
        try{ await identity.logout(); }finally{ window.location.href = "admin-login.html"; }
      });

      $("btnRefreshAnalytics").addEventListener("click", async ()=>{
        hideAlert();
        try{ await loadAnalytics(identity); }
        catch(e){ showAlert(e.message, "error"); }
      });

      $("btnLoadUsers").addEventListener("click", async ()=>{
        hideAlert();
        try{ await loadUsers(identity); }
        catch(e){ showAlert(e.message, "error"); }
      });

      $("userSearch").addEventListener("input", ()=>renderUsersTable(cachedUsers));

      $("newRole").addEventListener("change", ()=>{
        $("newParentWrap").style.display = ($("newRole").value === "agent") ? "block" : "none";
      });
      $("newRole").dispatchEvent(new Event("change"));

      $("btnCreateUser").addEventListener("click", async ()=>{
        hideAlert();
        const btn = $("btnCreateUser");
        const old = btn.textContent;
        btn.disabled = true; btn.textContent = "Creating...";
        try{ await createUser(identity); }
        catch(e){ showAlert(e.message, "error"); }
        finally{ btn.disabled = false; btn.textContent = old; }
      });

      $("btnLoadPayout").addEventListener("click", async ()=>{
        hideAlert();
        try{ await loadPayout(identity); }
        catch(e){ showAlert(e.message, "error"); $("payStatus").textContent="—"; }
      });

      $("btnCreatePayoutBatch").addEventListener("click", async ()=>{
        hideAlert();
        const btn = $("btnCreatePayoutBatch");
        const old = btn.textContent;
        btn.disabled = true; btn.textContent = "Creating...";
        try{ await createPayoutBatch(identity); }
        catch(e){ showAlert(e.message, "error"); }
        finally{ btn.disabled = false; btn.textContent = old; }
      });

      renderEarningsPlaceholder();
      try{ await loadAnalytics(identity); }
      catch(e){ showAlert(e.message, "error"); }
    }

    init();
  </script>
</body>
</html>
