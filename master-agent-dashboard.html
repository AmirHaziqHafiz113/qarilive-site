<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Master Agent Dashboard | QariLive</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Netlify Identity Widget -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold:'#c9a14a',
            'gold-soft':'#f5e6b3',
            blackish:'#050505',
            darkish:'#0b0b0b'
          },
          fontFamily: {
            inter:['Inter','sans-serif'],
            playfair:['Playfair Display','serif']
          },
          boxShadow: {
            goldGlow: '0 0 34px rgba(201,161,74,.22)'
          }
        }
      }
    }
  </script>

  <style>
    body{
      background:
        radial-gradient(900px 420px at 15% 0%, rgba(201, 161, 74, .18), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(245, 230, 179, .10), transparent 60%),
        radial-gradient(circle at top, #121212, #000 70%);
    }
    .glass{
      background: rgba(0,0,0,.42);
      border: 1px solid rgba(201,161,74,.16);
      backdrop-filter: blur(10px);
    }
    .soft-border{ border: 1px solid rgba(255,255,255,.10); }
    .focus-gold:focus{
      outline:none;
      border-color: rgba(201,161,74,.65);
      box-shadow: 0 0 0 4px rgba(201,161,74,.12);
    }
    .chip{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(201,161,74,.18);
    }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background: rgba(0,0,0,.35); }
  </style>
</head>

<body class="m-0 font-inter text-white/90 min-h-screen">

  <!-- HEADER -->
  <header class="sticky top-0 z-50 border-b border-gold/15 bg-black/60 backdrop-blur">
    <div class="max-w-[1100px] mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
      <a href="index.html" class="flex items-center gap-3 no-underline">
        <div class="w-9 h-9 rounded-xl bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] grid place-items-center shadow-goldGlow">
          <span class="font-playfair text-black text-sm">Q</span>
        </div>
        <div>
          <div class="font-playfair text-gold-soft text-lg leading-tight">QariLive™</div>
          <div class="text-xs text-white/45">Master Agent Dashboard</div>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <a href="index.html" class="hidden sm:inline-flex px-4 py-2 rounded-full font-semibold text-black no-underline bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
          Back to Site
        </a>
        <button id="btnLogout" class="px-4 py-2 rounded-full font-semibold soft-border text-white/85 bg-black/25 hover:border-gold/60 hover:bg-black/40 transition">
          Logout
        </button>
      </div>
    </div>

    <div class="sm:hidden px-4 pb-3">
      <a href="index.html" class="w-full inline-flex justify-center px-4 py-2 rounded-full font-semibold text-black no-underline bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
        Back to Site
      </a>
    </div>
  </header>

  <!-- MAIN (VERTICAL / SCROLL DOWN) -->
  <main class="max-w-[1100px] mx-auto px-4 sm:px-6 py-8 sm:py-10 space-y-6">

    <!-- TOP INTRO -->
    <section class="glass rounded-2xl p-6 sm:p-7">
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
        <div>
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full chip">
            <span class="w-2 h-2 rounded-full bg-gold"></span>
            <span class="text-gold-soft text-xs">Master Agent</span>
          </div>

          <h1 class="mt-3 font-playfair text-gold-soft text-3xl sm:text-[2.2rem] leading-tight">
            Welcome, <span id="txtName" class="text-white/90">—</span>
          </h1>
          <p class="mt-2 text-white/65">
            Track Agents under you and view customer submissions they uploaded.
          </p>

          <div class="mt-4 flex flex-wrap gap-2">
            <span class="px-3 py-1.5 rounded-full text-xs chip text-white/80">
              Email: <span id="txtEmail" class="text-white/90">—</span>
            </span>
            <span class="px-3 py-1.5 rounded-full text-xs chip text-white/80">
              Role: <span id="txtRole" class="text-white/90">—</span>
            </span>
          </div>
        </div>

        <div class="min-w-[260px]">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Master Agent REF</div>
          <div id="txtMACode" class="mt-2 text-3xl font-semibold text-gold-soft">—</div>

          <div class="mt-4 flex gap-2">
            <button id="copyCode" class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition font-semibold">
              Copy REF
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- ALERT -->
    <section id="alertBox" class="hidden glass rounded-2xl p-4 text-sm text-white/85"></section>

    <!-- LINKS -->
    <section class="glass rounded-2xl p-6 sm:p-7 space-y-5">
      <div>
        <div class="text-[11px] text-white/45 uppercase tracking-wider">Special Landing Page Link</div>
        <a id="txtLink" href="#" target="_blank" class="mt-2 block text-sm text-white/85 underline underline-offset-4 break-all">—</a>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="copyLink" class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition font-semibold">
            Copy Link
          </button>
          <button id="btnShareWA" class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition font-semibold">
            Share WhatsApp
          </button>
        </div>
        <div class="mt-2 text-[11px] text-white/45">Tip: Landing reads <span class="text-white/70">ref</span> from URL.</div>
      </div>

      <div class="pt-4 border-t border-white/10"></div>

      <div>
        <div class="text-[11px] text-white/45 uppercase tracking-wider">Agent Registration Link</div>
        <a id="txtAgentRegLink" href="#" target="_blank" class="mt-2 block text-sm text-white/85 underline underline-offset-4 break-all">—</a>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="copyAgentRegLink" class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition font-semibold">
            Copy Agent Link
          </button>
          <button id="btnShareAgentRegWA" class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition font-semibold">
            Share Agent WhatsApp
          </button>
        </div>

        <div class="mt-2 text-[11px] text-white/45">Example: <span class="text-white/70">agent-auth.html?ref=MA897</span></div>
      </div>
    </section>

    <!-- AGENTS (COUNT + TABLE) -->
    <section class="glass rounded-2xl p-6 sm:p-7">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <h2 class="font-playfair text-gold-soft text-2xl">Agents Under You</h2>
          <p class="mt-1 text-sm text-white/60">Shows agents where <span class="text-white/80">ma_code = your REF</span>.</p>
        </div>
        <div class="text-left md:text-right">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Total Agents</div>
          <div id="txtAgentCount" class="mt-1 text-3xl font-semibold text-gold-soft">—</div>
        </div>
      </div>

      <div class="mt-4 flex flex-col lg:flex-row lg:items-center gap-3">
        <div class="flex flex-wrap gap-2 items-center">
          <button id="btnRefreshAgents" class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
            Refresh Agents
          </button>
          <div id="txtAgentsStatus" class="text-sm text-white/55">—</div>
        </div>

        <div class="flex-1"></div>

        <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
          <input id="agentsSearch" class="w-full sm:w-[280px] px-4 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30 text-sm"
                 placeholder="Search agents..." />
          <select id="agentsPerPage" class="px-3 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white/85 text-sm">
            <option value="5">5 / page</option>
            <option value="10" selected>10 / page</option>
            <option value="20">20 / page</option>
            <option value="50">50 / page</option>
          </select>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table id="agentsTable" class="min-w-full text-sm soft-border rounded-xl overflow-hidden">
          <thead class="bg-black/30">
            <tr class="text-left">
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="full_name">Full Name</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="whatsapp">WhatsApp</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="email">Email</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="created_at">Joined</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="last_login">Last Login</th>
            </tr>
          </thead>
          <tbody id="tblAgents" class="divide-y divide-white/10 bg-black/15">
            <tr><td class="px-4 py-4 text-white/60" colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button id="agentsPrev" class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm">Prev</button>
        <div id="agentsPageInfo" class="text-sm text-white/55">—</div>
        <button id="agentsNext" class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm">Next</button>
      </div>
    </section>

    <!-- SUBMISSIONS (COUNT + TABLE) -->
    <section class="glass rounded-2xl p-6 sm:p-7">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <h2 class="font-playfair text-gold-soft text-2xl">Customer Submissions</h2>
          <p class="mt-1 text-sm text-white/60">All customer purchases uploaded by your agents.</p>
        </div>
        <div class="text-left md:text-right">
          <div class="text-[11px] text-white/45 uppercase tracking-wider">Total Submissions</div>
          <div id="txtSubCount" class="mt-1 text-3xl font-semibold text-gold-soft">—</div>
        </div>
      </div>

      <div class="mt-4 flex flex-col lg:flex-row lg:items-center gap-3">
        <div class="flex flex-wrap gap-2 items-center">
          <button id="btnRefreshSubs" class="px-4 py-2 rounded-xl soft-border text-white/85 bg-black/20 hover:border-gold/60 hover:bg-black/40 transition text-sm font-semibold">
            Refresh Submissions
          </button>
          <div id="txtSubsStatus" class="text-sm text-white/55">—</div>
        </div>

        <div class="flex-1"></div>

        <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
          <input id="subsSearch" class="w-full sm:w-[300px] px-4 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30 text-sm"
                 placeholder="Search submissions..." />
          <select id="subsPerPage" class="px-3 py-2 rounded-xl bg-black/25 soft-border focus-gold text-white/85 text-sm">
            <option value="5">5 / page</option>
            <option value="10" selected>10 / page</option>
            <option value="20">20 / page</option>
            <option value="50">50 / page</option>
          </select>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table id="subsTable" class="min-w-full text-sm soft-border rounded-xl overflow-hidden">
          <thead class="bg-black/30">
            <tr class="text-left">
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="customer_name">Customer Name</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="customer_phone">Customer Phone</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="agent_name">Agent</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="product">Product</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="qty">Qty</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="purchase_amount_rm">Amount (RM)</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="status">Status</th>
              <th class="px-4 py-3 text-white/70 font-semibold sortable" data-key="created_at">Submitted At</th>
              <th class="px-4 py-3 text-white/70 font-semibold">Proof</th>
            </tr>
          </thead>
          <tbody id="tblSubs" class="divide-y divide-white/10 bg-black/15">
            <tr><td class="px-4 py-4 text-white/60" colspan="9">Not loaded yet.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button id="subsPrev" class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm">Prev</button>
        <div id="subsPageInfo" class="text-sm text-white/55">—</div>
        <button id="subsNext" class="px-3 py-2 rounded-xl soft-border bg-black/20 hover:border-gold/60 text-sm">Next</button>
      </div>
    </section>

    <!-- PROFILE & PAYOUT (LAST SECTION) -->
    <section class="glass rounded-2xl p-6 sm:p-7">
      <h2 class="font-playfair text-gold-soft text-2xl">Profile & Payout</h2>
      <p class="mt-1 text-sm text-white/60">
        Name/WhatsApp stored in <span class="text-white/80">Identity metadata</span>.
        Bank details stored in <span class="text-white/80">Neon DB</span>.
      </p>

      <form id="profileForm" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs text-white/60">Full Name</label>
          <input id="full_name" class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30" placeholder="Your full name" />
        </div>

        <div>
          <label class="text-xs text-white/60">WhatsApp Number</label>
          <input id="whatsapp" inputmode="numeric" class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30" placeholder="60123456789" />
          <div class="mt-1 text-[11px] text-white/45">No “+”, no spaces.</div>
        </div>

        <div class="md:col-span-2 pt-2 border-t border-white/10"></div>

        <div>
          <label class="text-xs text-white/60">Bank Name</label>
          <input id="bank_name" class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30" placeholder="Maybank / CIMB / etc" />
        </div>

        <div>
          <label class="text-xs text-white/60">Account Holder Name</label>
          <input id="bank_holder" class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30" placeholder="Name as per bank" />
        </div>

        <div class="md:col-span-2">
          <label class="text-xs text-white/60">Account Number</label>
          <input id="bank_account" class="mt-1 w-full px-4 py-3 rounded-xl bg-black/25 soft-border focus-gold text-white placeholder:text-white/30" placeholder="Full account number" />
          <div class="mt-1 text-[11px] text-white/45">We mask it after loading. To change, type the full number again.</div>
        </div>

        <div class="md:col-span-2">
          <button type="submit" id="btnSaveProfile" class="w-full px-4 py-3 rounded-xl font-semibold text-black bg-[linear-gradient(135deg,#c9a14a,#f5e6b3)] shadow-goldGlow hover:opacity-90 transition">
            Save Profile
          </button>
        </div>
      </form>

      <div class="mt-6 rounded-2xl soft-border bg-black/20 p-5">
        <div class="font-semibold text-gold-soft">Referral Checklist</div>
        <ul class="mt-2 space-y-1 text-sm text-white/70">
          <li>• Copy your REF code</li>
          <li>• Share your special landing link</li>
          <li>• Share agent registration link</li>
          <li>• Agents submit customer purchases</li>
          <li>• Admin verifies and pays commission</li>
        </ul>
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="border-t border-gold/15 bg-black/60">
    <div class="max-w-[1100px] mx-auto px-4 sm:px-6 py-10 text-center">
      <div class="flex flex-col items-center gap-4">
        <img src="our_logo.jpg" alt="IT People Sdn Bhd" class="w-[180px] sm:w-[220px] md:w-[260px] max-w-full h-auto opacity-90" />
        <small class="text-white/45">© 2025 IT People Sdn Bhd • QariLive Operations</small>
      </div>
    </div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);

    // ---- UI Alerts ----
    const alertBox = $("alertBox");
    function showAlert(msg, type = "info") {
      alertBox.classList.remove("hidden");
      alertBox.textContent = msg;
      alertBox.classList.remove("border-red-500/25", "bg-red-500/10", "border-gold/20", "bg-black/30");
      if (type === "error") alertBox.classList.add("border-red-500/25", "bg-red-500/10");
      else alertBox.classList.add("border-gold/20", "bg-black/30");
    }
    function hideAlert(){ alertBox.classList.add("hidden"); alertBox.textContent = ""; }
    function safeRedirect(url){ window.location.href = url; }

    // ---- Identity Helper ----
    function waitForIdentity(){
      return new Promise((resolve) => {
        const tick = () => {
          if (window.netlifyIdentity) return resolve(window.netlifyIdentity);
          setTimeout(tick, 50);
        };
        tick();
      });
    }

    // ---- Config ----
    const SITE_BASE = window.location.origin + "/";
    const LANDING_PATH = "master-agent-landing.html";
    const LOGIN_PAGE = "master-agent-auth.html";
    const AGENT_AUTH_PAGE = "agent-auth.html";

    function buildReferralLink(maCode){
      return SITE_BASE + LANDING_PATH + "?ref=" + encodeURIComponent(maCode || "");
    }
    function buildAgentRegLink(maCode){
      return SITE_BASE + AGENT_AUTH_PAGE + "?ref=" + encodeURIComponent(maCode || "");
    }

    function copyToClipboard(text){
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        showAlert("Copied to clipboard.");
        setTimeout(hideAlert, 1200);
      }).catch(() => showAlert("Copy failed. Please copy manually.", "error"));
    }
    function openWhatsAppWithText(text){
      window.open("https://wa.me/?text=" + encodeURIComponent(text || ""), "_blank");
    }

    // ---- MA Code generation (only used if missing) ----
    function makeMACode(){
      const rand = Math.random().toString(36).slice(2, 6).toUpperCase();
      const t = Date.now().toString().slice(-4);
      return `MA${t}${rand}`;
    }

    async function ensureMACode(identity){
      let u = identity.currentUser();
      if (!u) return null;

      const meta = u.user_metadata || {};
      let maCode = String(meta.ma_code || meta?.data?.ma_code || "").toUpperCase().trim();

      if (!meta.ma_code && meta?.data?.ma_code) {
        await u.update({ data: { ...meta, role: meta.role || "master_agent", ma_code: maCode } });
        u = identity.currentUser();
        return maCode;
      }

      if (!maCode){
        maCode = makeMACode();
        await u.update({ data: { ...meta, role: meta.role || "master_agent", ma_code: maCode } });
        u = identity.currentUser();
      }
      return maCode;
    }

    // ---- Auth header for Netlify Functions ----
    async function getAuthHeader(identity){
      const u = identity.currentUser();
      if (!u) return {};
      const token = await u.jwt();
      return { "Authorization": "Bearer " + token };
    }

    // ---- Data helpers ----
    function fmtDate(iso){
      if (!iso) return "—";
      try{
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "—";
        return d.toLocaleString();
      }catch{ return "—"; }
    }
    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Notes meta parsing (from agent-submission-create)
    // Example: ... \n[QL_PRODUCT]=QariLive Lite;[QL_QTY]=2;[QL_UNIT]=1500;
    function parseMetaFromNotes(notes){
      const out = { product:"—", qty:"—", unit:"—" };
      const s = String(notes || "");
      const mProd = s.match(/\[QL_PRODUCT\]=([^;]+);/);
      const mQty  = s.match(/\[QL_QTY\]=([^;]+);/);
      const mUnit = s.match(/\[QL_UNIT\]=([^;]+);/);
      if (mProd) out.product = mProd[1].trim();
      if (mQty) out.qty = mQty[1].trim();
      if (mUnit) out.unit = mUnit[1].trim();
      return out;
    }

    // ---- Simple DataTable (client-side) ----
    function makeDataTable(opts){
      const {
        tableId, tbodyId, searchId, perPageId, prevId, nextId, pageInfoId,
        emptyMessage, columns
      } = opts;

      const table = $(tableId);
      const tbody = $(tbodyId);
      const search = $(searchId);
      const perPage = $(perPageId);
      const prevBtn = $(prevId);
      const nextBtn = $(nextId);
      const pageInfo = $(pageInfoId);

      let raw = [];
      let filtered = [];
      let page = 1;
      let pageSize = Number(perPage?.value || 10);
      let sortKey = null;
      let sortDir = "desc"; // default
      const sortIcons = { asc: "▲", desc: "▼" };

      function getCellText(col, row){
        if (col.text) return String(col.text(row) ?? "");
        const v = row?.[col.key];
        return v == null ? "" : String(v);
      }

      function rowSearchText(row){
        return columns.map(c => getCellText(c, row)).join(" ").toLowerCase();
      }

      function applyFilter(){
        const q = String(search?.value || "").trim().toLowerCase();
        if (!q) filtered = raw.slice();
        else filtered = raw.filter(r => rowSearchText(r).includes(q));
      }

      function applySort(){
        if (!sortKey) return;
        const col = columns.find(c => (c.sortKey || c.key) === sortKey);
        const getter = col?.sortValue
          ? (r) => col.sortValue(r)
          : (r) => getCellText(col || {key:sortKey}, r);

        filtered.sort((a,b) => {
          const av = getter(a);
          const bv = getter(b);
          const an = typeof av === "number" ? av : Number(av);
          const bn = typeof bv === "number" ? bv : Number(bv);
          const bothNumeric = !Number.isNaN(an) && !Number.isNaN(bn);

          let res;
          if (bothNumeric) res = an - bn;
          else res = String(av ?? "").localeCompare(String(bv ?? ""), undefined, {numeric:true, sensitivity:"base"});

          return sortDir === "asc" ? res : -res;
        });
      }

      function totalPages(){
        return Math.max(1, Math.ceil(filtered.length / pageSize));
      }

      function clampPage(){
        const tp = totalPages();
        if (page > tp) page = tp;
        if (page < 1) page = 1;
      }

      function updateHeaderIcons(){
        if (!table) return;
        const ths = table.querySelectorAll("thead th.sortable");
        ths.forEach(th => {
          const key = th.getAttribute("data-key");
          const base = th.getAttribute("data-label") || th.textContent.replace(/ ▲| ▼/g,"").trim();
          th.setAttribute("data-label", base);
          if (key === sortKey) th.textContent = base + " " + (sortDir === "asc" ? sortIcons.asc : sortIcons.desc);
          else th.textContent = base;
        });
      }

      function render(){
        pageSize = Number(perPage?.value || 10) || 10;

        applyFilter();
        applySort();
        clampPage();

        const tp = totalPages();
        const start = (page - 1) * pageSize;
        const slice = filtered.slice(start, start + pageSize);

        if (!slice.length){
          tbody.innerHTML = `<tr><td class="px-4 py-4 text-white/60" colspan="${columns.length}">${escapeHtml(emptyMessage || "No results.")}</td></tr>`;
        } else {
          tbody.innerHTML = slice.map(row => {
            const tds = columns.map(col => {
              const html = col.render ? col.render(row) : escapeHtml(getCellText(col, row) || "—");
              return `<td class="px-4 py-3 ${col.tdClass || "text-white/75"}">${html}</td>`;
            }).join("");
            return `<tr>${tds}</tr>`;
          }).join("");
        }

        pageInfo.textContent = `Page ${page} / ${tp} • ${filtered.length} result(s)`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= tp;

        prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
        nextBtn.classList.toggle("opacity-50", nextBtn.disabled);

        updateHeaderIcons();
      }

      function setData(rows){
        raw = Array.isArray(rows) ? rows.slice() : [];
        page = 1;
        render();
      }

      // events
      search?.addEventListener("input", () => { page = 1; render(); });
      perPage?.addEventListener("change", () => { page = 1; render(); });

      prevBtn?.addEventListener("click", () => { page -= 1; render(); });
      nextBtn?.addEventListener("click", () => { page += 1; render(); });

      table?.querySelectorAll("thead th.sortable").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          if (!key) return;
          if (sortKey === key) sortDir = (sortDir === "asc" ? "desc" : "asc");
          else { sortKey = key; sortDir = "asc"; }
          page = 1;
          render();
        });
      });

      return { setData, render, setSort: (key, dir="desc") => { sortKey = key; sortDir = dir; render(); } };
    }

    // ---- Secure payout: load/save via functions ----
    let lastRealBankAccount = "";

    function maskAccount(acc){
      if (!acc) return "";
      const s = String(acc);
      if (s.length <= 4) return "****";
      return "**** **** " + s.slice(-4);
    }

    async function loadPayoutDetails(identity){
      try {
        const auth = await getAuthHeader(identity);
        const res = await fetch("/.netlify/functions/ma-payout-get", { method:"GET", headers:{ ...auth } });
        const out = await res.json().catch(() => ({}));
        if (!res.ok) return;
        const data = out.data || null;
        if (!data) return;

        $("bank_name").value = data.bank_name || "";
        $("bank_holder").value = data.bank_account_name || "";

        lastRealBankAccount = data.bank_account_number || "";
        $("bank_account").value = lastRealBankAccount ? maskAccount(lastRealBankAccount) : "";
      } catch(e){ console.error(e); }
    }

    function resolveBankAccountToSave(){
      const val = ($("bank_account").value || "").trim();
      if (!val) return "";
      if (val.includes("*")) return lastRealBankAccount || "";
      return val;
    }

    async function savePayoutDetails(identity){
      const auth = await getAuthHeader(identity);
      const payload = {
        ma_code: ($("txtMACode").textContent || "").trim(),
        full_name: ($("full_name").value || "").trim(),
        whatsapp: ($("whatsapp").value || "").trim(),
        bank_name: ($("bank_name").value || "").trim(),
        bank_account_name: ($("bank_holder").value || "").trim(),
        bank_account_number: resolveBankAccountToSave()
      };

      const res = await fetch("/.netlify/functions/ma-payout-set", {
        method:"POST",
        headers:{ "Content-Type":"application/json", ...auth },
        body: JSON.stringify(payload)
      });

      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) throw new Error(out.error || "Failed to save payout details.");

      lastRealBankAccount = payload.bank_account_number;
      $("bank_account").value = lastRealBankAccount ? maskAccount(lastRealBankAccount) : "";
    }

    // ---- Identity metadata save (non-sensitive only) ----
    async function saveUserMetadata(identity, patch){
      const u = identity.currentUser();
      if (!u) { safeRedirect(LOGIN_PAGE); return; }
      const currentMeta = u.user_metadata || {};
      await u.update({ data: { ...currentMeta, ...patch } });
    }

    // ---- Agents list ----
    function setAgentsStatus(text){ $("txtAgentsStatus").textContent = text || "—"; }
    const agentsDT = makeDataTable({
      tableId: "agentsTable",
      tbodyId: "tblAgents",
      searchId: "agentsSearch",
      perPageId: "agentsPerPage",
      prevId: "agentsPrev",
      nextId: "agentsNext",
      pageInfoId: "agentsPageInfo",
      emptyMessage: "No agents found.",
      columns: [
        { key:"full_name", tdClass:"text-white/85", text:(r)=>r.full_name||"—" },
        { key:"whatsapp", tdClass:"text-white/75", text:(r)=>r.whatsapp||"—" },
        { key:"email", tdClass:"text-white/75", text:(r)=>r.email||"—" },
        { key:"created_at", tdClass:"text-white/60", text:(r)=>fmtDate(r.created_at), sortValue:(r)=>new Date(r.created_at||0).getTime() },
        { key:"last_login", tdClass:"text-white/60", text:(r)=>fmtDate(r.last_login), sortValue:(r)=>new Date(r.last_login||0).getTime() },
      ]
    });
    agentsDT.setSort("created_at","desc");

    async function loadAgents(identity, maCode){
      try{
        setAgentsStatus("Loading agents...");
        $("txtAgentCount").textContent = "—";
        agentsDT.setData([]);

        const auth = await getAuthHeader(identity);
        const qs = new URLSearchParams({ ma_code: maCode, t: Date.now() });
        const url = "/.netlify/functions/ma-agent-list?" + qs.toString();
        const res = await fetch(url, { method:"GET", headers:{ ...auth } });
        const out = await res.json().catch(() => ({}));

        if (!res.ok || !out.ok){
          const msg = out?.error || out?.details || ("HTTP " + res.status);
          setAgentsStatus("Failed to load agents: " + msg);
          showAlert("Agents list error: " + msg, "error");
          $("txtAgentCount").textContent = "0";
          agentsDT.setData([]);
          return;
        }

        $("txtAgentCount").textContent = String(out.count ?? (out.agents?.length ?? 0));
        agentsDT.setData(out.agents || []);
        setAgentsStatus("Updated: " + new Date().toLocaleTimeString());
      }catch(e){
        console.error(e);
        setAgentsStatus("Failed to load agents.");
        showAlert(e?.message || "Failed to load agents list.", "error");
        $("txtAgentCount").textContent = "0";
        agentsDT.setData([]);
      }
    }

    // ---- Submissions list ----
    function setSubsStatus(text){ $("txtSubsStatus").textContent = text || "—"; }
    const subsDT = makeDataTable({
      tableId: "subsTable",
      tbodyId: "tblSubs",
      searchId: "subsSearch",
      perPageId: "subsPerPage",
      prevId: "subsPrev",
      nextId: "subsNext",
      pageInfoId: "subsPageInfo",
      emptyMessage: "No submissions found.",
      columns: [
        { key:"customer_name", tdClass:"text-white/85", text:(r)=>r.customer_name||"—" },
        { key:"customer_phone", tdClass:"text-white/75", text:(r)=>r.customer_phone||"—" },
        { key:"agent_name", tdClass:"text-white/75", text:(r)=>r.agent_name||r.agent_email||"—" },
        { key:"product", tdClass:"text-white/75", text:(r)=>parseMetaFromNotes(r.notes).product },
        { key:"qty", tdClass:"text-white/75", text:(r)=>parseMetaFromNotes(r.notes).qty, sortValue:(r)=>Number(parseMetaFromNotes(r.notes).qty)||0 },
        { key:"purchase_amount_rm", tdClass:"text-white/75", text:(r)=> (r.purchase_amount_rm ?? "—") , sortValue:(r)=> Number(r.purchase_amount_rm)||0 },
        { key:"status", tdClass:"text-white/60", text:(r)=>r.status||"pending" },
        { key:"created_at", tdClass:"text-white/60", text:(r)=>fmtDate(r.created_at), sortValue:(r)=>new Date(r.created_at||0).getTime() },
        { key:"proof_url", tdClass:"text-white/75", render:(r)=> {
            const proofUrl = r.proof_url || "";
            return proofUrl
              ? `<a class="underline underline-offset-4 text-white/85" target="_blank" href="${escapeHtml(proofUrl)}">View</a>`
              : "—";
          }, text:(r)=>r.proof_url||"" }
      ]
    });
    subsDT.setSort("created_at","desc");

    async function loadSubmissions(identity, maCode){
      try{
        setSubsStatus("Loading submissions...");
        $("txtSubCount").textContent = "—";
        subsDT.setData([]);

        const auth = await getAuthHeader(identity);
        const res = await fetch("/.netlify/functions/ma-submissions-list?ma_code=" + encodeURIComponent(maCode) + "&t=" + Date.now(), {
          method:"GET",
          headers:{ ...auth }
        });

        const out = await res.json().catch(() => ({}));
        if (!res.ok || !out.ok) throw new Error(out.error || "Failed to load submissions list.");

        $("txtSubCount").textContent = String(out.count ?? 0);
        subsDT.setData(out.submissions || []);
        setSubsStatus("Updated: " + new Date().toLocaleTimeString());
      }catch(e){
        console.error(e);
        setSubsStatus("Failed to load submissions.");
        subsDT.setData([]);
        $("txtSubCount").textContent = "—";
      }
    }

    async function loadUser(identity){
      identity.init();
      let user = identity.currentUser();
      if (!user){ safeRedirect(LOGIN_PAGE); return null; }

      const maCode = await ensureMACode(identity);
      user = identity.currentUser();

      const email = user.email || "—";
      const meta = user.user_metadata || {};
      const fullName = meta.full_name || (email.includes("@") ? email.split("@")[0] : "Master Agent");
      const role = meta.role || "master_agent";

      $("txtName").textContent = fullName;
      $("txtEmail").textContent = email;
      $("txtRole").textContent = role;
      $("txtMACode").textContent = maCode || "—";

      const referralLink = buildReferralLink(maCode);
      $("txtLink").textContent = referralLink;
      $("txtLink").href = referralLink;

      const agentRegLink = buildAgentRegLink(maCode);
      $("txtAgentRegLink").textContent = agentRegLink;
      $("txtAgentRegLink").href = agentRegLink;

      $("full_name").value = meta.full_name || "";
      $("whatsapp").value = meta.whatsapp || "";

      await loadPayoutDetails(identity);

      $("copyCode").onclick = () => copyToClipboard(maCode);
      $("copyLink").onclick = () => copyToClipboard(referralLink);

      $("btnShareWA").onclick = () => {
        const text =
          "Hi! I’m a QariLive Master Agent (" + maCode + ").\n" +
          "Here’s my official purchase link:\n" + referralLink;
        openWhatsAppWithText(text);
      };

      $("copyAgentRegLink").onclick = () => copyToClipboard(agentRegLink);
      $("btnShareAgentRegWA").onclick = () => {
        const text =
          "Hi! Please register as my QariLive Agent using this link:\n" +
          agentRegLink + "\n\n" +
          "After registration, you can submit customer purchases for verification.";
        openWhatsAppWithText(text);
      };

      await loadAgents(identity, maCode);
      await loadSubmissions(identity, maCode);

      $("btnRefreshAgents").onclick = () => loadAgents(identity, maCode);
      $("btnRefreshSubs").onclick = () => loadSubmissions(identity, maCode);

      return user;
    }

    async function main(){
      const identity = await waitForIdentity();
      const user = await loadUser(identity);
      if (!user) return;

      $("btnLogout").addEventListener("click", async () => {
        try { await identity.logout(); }
        finally { safeRedirect(LOGIN_PAGE); }
      });

      $("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        hideAlert();

        const btn = $("btnSaveProfile");
        const oldText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Saving...";

        try {
          await saveUserMetadata(identity, {
            role: "master_agent",
            full_name: ($("full_name").value || "").trim(),
            whatsapp: ($("whatsapp").value || "").trim(),
          });

          await savePayoutDetails(identity);

          showAlert("Profile & payout details saved.");
          setTimeout(hideAlert, 1200);

          const u = identity.currentUser();
          const m = u?.user_metadata || {};
          $("txtName").textContent = m.full_name || $("txtName").textContent;

        } catch (err) {
          console.error(err);
          showAlert(err?.message || "Save failed.", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });
    }

    main();
  </script>
</body>
</html>
